<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“å°ä»£ç†ç®¡ç†åå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .download-links {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .download-links span {
            color: #4b5563;
            font-size: 13px;
        }

        .download-links a {
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            color: #333;
            font-size: 32px;
            font-weight: bold;
        }

        .stat-card .value.connected {
            color: #10b981;
        }

        .stat-card .value.disconnected {
            color: #ef4444;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .muted {
            color: #6b7280;
            font-size: 13px;
        }

        .shop-list {
            list-style: none;
        }

        .shop-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: box-shadow 0.3s;
        }

        .shop-item:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .shop-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .shop-id {
            font-size: 12px;
            color: #666;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-badge.connected {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        .history-status-success {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            background: #dcfce7;
            color: #166534;
            font-weight: 600;
        }

        .history-status-error {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            background: #fee2e2;
            color: #991b1b;
            font-weight: 600;
        }

        .printers-list {
            margin-top: 15px;
        }

        .printer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .printer-info {
            flex: 1;
        }

        .printer-ip {
            font-weight: bold;
            color: #333;
        }

        .printer-name {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .printer-actions {
            display: flex;
            gap: 8px;
        }

        .heartbeat-item {
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid #e5e7eb;
        }

        .heartbeat-item strong {
            color: #111827;
        }

        .heartbeat-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .heartbeat-logs summary {
            cursor: pointer;
            color: #4b5563;
            font-size: 13px;
        }

        .heartbeat-logs pre {
            background: #0f172a;
            color: #94a3b8;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.4;
            overflow-x: auto;
            margin-top: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 24px;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .note-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: box-shadow 0.3s;
            background: #f9fafb;
        }

        .note-item:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .note-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .note-content {
            color: #666;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            margin-bottom: 10px;
        }

        .note-meta {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 10px;
        }

        .note-actions {
            display: flex;
            gap: 8px;
        }

        .deploy-command {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 15px 0;
            word-break: break-all;
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #374151;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .copy-btn:hover {
            background: #4b5563;
        }

        .copy-btn.copied {
            background: #10b981;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 100%;
        }

        .login-box h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
            text-align: center;
        }

        .login-box p {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
        }

        .login-form input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .login-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-form button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-form button:hover {
            background: #5568d3;
        }

        .login-form button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .login-error {
            color: #ef4444;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            z-index: 100;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>æ‰“å°ä»£ç†ç®¡ç†åå°</h1>
            <p>è¯·ç™»å½•ä»¥ç»§ç»­</p>
            <form id="loginForm" class="login-form">
                <input type="text" id="username" placeholder="ç”¨æˆ·å" required autocomplete="username">
                <input type="password" id="password" placeholder="å¯†ç " required autocomplete="current-password">
                <button type="submit" id="loginBtn">ç™»å½•</button>
                <div id="loginError" class="login-error"></div>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <button class="logout-btn" onclick="handleLogout()">ç™»å‡º</button>
        <div class="container">
        <div class="header">
            <h1>æ‰“å°ä»£ç†ç®¡ç†åå°</h1>
            <p>ç»Ÿä¸€ç®¡ç†å„åˆ†åº—æœ¬åœ°æ‰“å°ä»£ç†ï¼ŒæŸ¥çœ‹è¿æ¥çŠ¶æ€ã€å¿ƒè·³ä¿¡æ¯ï¼Œå¹¶è¿›è¡Œè¿œç¨‹é…ç½®ã€‚</p>
            <div class="download-links">
                <span>å®¢æˆ·ç«¯ä¸‹è½½ï¼š</span>
                <div id="download-links-container">
                    <span class="muted">åŠ è½½ä¸­...</span>
                </div>
            </div>
            <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                <strong>ğŸ–¥ï¸ RestDesk è¿œç¨‹è¿ç»´ä¿¡æ¯</strong>
                <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">
                    åœ¨åˆ†åº—ç”µè„‘ä¸Šå®‰è£… RestDesk åï¼Œå¡«å†™ä»¥ä¸‹é…ç½®å³å¯è¿æ¥ï¼š
                </p>
                <div style="margin-top: 10px; background: #1f2937; color: #f8fafc; padding: 12px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 13px; word-break: break-all; position: relative;">
                    <button class="copy-btn" onclick="copyRestDeskInfo(event)" style="position: absolute; top: 10px; right: 10px; background: #4c1d95; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; z-index: 10;">å¤åˆ¶</button>
                    <div id="restDeskInfo" style="padding-right: 80px; line-height: 1.6;">
IDæœåŠ¡å™¨: 90.195.120.165:21116
ä¸­ç»§æœåŠ¡å™¨: 90.195.120.165:21117
å¯†é’¥: VhrFMc1CL7jkcVmcwxdXI6KSkmRa6fuDtWKKM60vc1Q=
                    </div>
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>æ€»åˆ†åº—æ•°</h3>
                <div class="value" id="totalShops">0</div>
            </div>
            <div class="stat-card">
                <h3>å·²è¿æ¥</h3>
                <div class="value connected" id="connectedShops">0</div>
            </div>
            <div class="stat-card">
                <h3>æœªè¿æ¥</h3>
                <div class="value disconnected" id="disconnectedShops">0</div>
            </div>
            <div class="stat-card">
                <h3>å¿ƒè·³åœ¨çº¿</h3>
                <div class="value connected" id="heartbeatOnline">0</div>
            </div>
            <div class="stat-card">
                <h3>å¿ƒè·³ç¦»çº¿</h3>
                <div class="value disconnected" id="heartbeatOffline">0</div>
            </div>
            <div class="stat-card">
                <h3>ç‰ˆæœ¬åˆ†å¸ƒ</h3>
                <div class="value" id="versionSummary">--</div>
                <div class="muted" id="versionDetail" style="margin-top:8px;font-size:12px;"></div>
            </div>
            <div class="stat-card">
                <h3>å‘Šè­¦æ•°é‡</h3>
                <div class="value disconnected" id="alertCount">0</div>
                <div class="muted" id="alertDetail" style="margin-top:8px;font-size:12px;"></div>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>
                    åˆ†åº—åˆ—è¡¨
                    <button class="btn btn-success" onclick="showAddShopModal()">+ æ·»åŠ åˆ†åº—</button>
                </h2>
                <ul class="shop-list" id="shopList">
                    <li>åŠ è½½ä¸­...</li>
                </ul>
            </div>

            <div class="card">
                <h2>æœ¬åœ° Agent å¿ƒè·³</h2>
                <div id="heartbeatList">åŠ è½½ä¸­...</div>
            </div>
            <div class="card">
                <h2>å¼‚å¸¸ä¸å‘Šè­¦</h2>
                <div id="alertsList" class="muted">æš‚æ— å¼‚å¸¸</div>
            </div>
            <div class="card">
                <h2>
                    ç¬”è®°ç®¡ç†
                    <button class="btn btn-success" onclick="showAddNoteModal()">+ æ·»åŠ ç¬”è®°</button>
                </h2>
                <div id="notesList">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘åˆ†åº—æ¨¡æ€æ¡† -->
    <div class="modal" id="shopModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">æ·»åŠ åˆ†åº—</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="shopForm">
                <div class="form-group">
                    <label>åˆ†åº—ID *</label>
                    <input type="text" id="shopId" required placeholder="ä¾‹å¦‚: shop1, bbq">
                </div>
                <div class="form-group">
                    <label>åˆ†åº—åç§°</label>
                    <input type="text" id="shopName" placeholder="ä¾‹å¦‚: æµ‹è¯•åˆ†åº—">
                </div>
                <div class="form-group">
                    <label>å…³è”å…¬å¸ IDï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="managerCompanyId" placeholder="ä¾‹å¦‚: 27">
                    <p style="margin-top: 6px; font-size: 12px; color: #6b7280;">
                        ä¸ manager_next çš„ companyId å¯¹åº”ï¼Œæ–¹ä¾¿è‡ªåŠ¨ç”Ÿæˆ NEXT_PUBLIC_PRINT_AGENT_MAPã€‚
                    </p>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ·»åŠ æ‰“å°æœºæ¨¡æ€æ¡† -->
    <div class="modal" id="printerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="printerModalTitle">æ·»åŠ æ‰“å°æœº</h3>
                <button class="close-btn" onclick="closePrinterModal()">&times;</button>
            </div>
            <form id="printerForm">
                <div class="form-group">
                    <label>IP åœ°å€ *</label>
                    <input type="text" id="printerIp" required placeholder="ä¾‹å¦‚: 192.168.0.31">
                </div>
                <div class="form-group">
                    <label>ç«¯å£</label>
                    <input type="number" id="printerPort" value="9100" placeholder="9100">
                </div>
                <div class="form-group">
                    <label>æ‰“å°æœºåç§°</label>
                    <input type="text" id="printerName" placeholder="ä¾‹å¦‚: å¨æˆ¿æ‰“å°æœº1">
                </div>
                <div class="form-group">
                    <label>ç±»å‹</label>
                    <select id="printerType">
                        <option value="Kitchen">Kitchen</option>
                        <option value="FrontDesk">FrontDesk</option>
                        <option value="Bar">Bar</option>
                        <option value="Receipt">Receipt</option>
                        <option value="Label">Label</option>
                    </select>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closePrinterModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success" id="printerSubmitBtn">æ·»åŠ </button>
                </div>
            </form>
        </div>
    </div>

    <!-- éƒ¨ç½²è„šæœ¬æ¨¡æ€æ¡† -->
    <div class="modal" id="deployModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ä¸€é”®éƒ¨ç½²è„šæœ¬</h3>
                <button class="close-btn" onclick="closeDeployModal()">&times;</button>
            </div>
            <div>
                <p style="margin-bottom: 15px; color: #666;">é€‰æ‹©å¯¹åº”ç¯å¢ƒè¿è¡Œå‘½ä»¤ï¼š</p>
                <div class="space-y-4">
                    <div>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <strong>WSL / Linux</strong>
                            <span style="font-size:12px;color:#6b7280;">é»˜è®¤éƒ¨ç½²è„šæœ¬</span>
                        </div>
                <div class="deploy-command">
                            <button class="copy-btn" onclick="copyDeployCommand(event, 'wsl')">å¤åˆ¶</button>
                            <div id="deployCommandWsl" style="padding-right: 80px;">åŠ è½½ä¸­...</div>
                        </div>
                    </div>
                    <div>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <strong>macOS</strong>
                            <span style="font-size:12px;color:#6b7280;">æœ¬åœ°è°ƒè¯•æˆ–åº—å†… Mac è®¾å¤‡</span>
                        </div>
                        <div class="deploy-command">
                            <button class="copy-btn" onclick="copyDeployCommand(event, 'mac')">å¤åˆ¶</button>
                            <div id="deployCommandMac" style="padding-right: 80px;">åŠ è½½ä¸­...</div>
                        </div>
                    </div>
                </div>
                <p style="margin-top: 15px; color: #666; font-size: 14px;">
                    ğŸ’¡ æç¤ºï¼šåœ¨å¯¹åº”ç¯å¢ƒçš„ç»ˆç«¯ä¸­ç²˜è´´å‘½ä»¤å¹¶è¿è¡Œå³å¯å®Œæˆéƒ¨ç½²ï¼›macOS è„šæœ¬ä¼šæ£€æµ‹ Node.js å¹¶æç¤ºä½¿ç”¨ Homebrew å®‰è£…ã€‚
                </p>
            </div>
        </div>
    </div>

    <div class="modal" id="remoteConfigModal">
        <div class="modal-content" style="max-width: 680px;">
            <div class="modal-header">
                <h3 id="remoteConfigTitle">è¿œç¨‹é…ç½®</h3>
                <button class="close-btn" onclick="closeRemoteConfigModal()">&times;</button>
            </div>
            <form id="remoteConfigForm">
                <p class="muted" style="margin-bottom:12px;">é€‰æ‹©é»˜è®¤æ‰“å°æœºå¹¶å¯åŒæ­¥æ›´æ–°åˆ«åã€‚æäº¤åå°†é€šè¿‡ WebSocket å®æ—¶ä¸‹å‘åˆ°é—¨åº— Agentã€‚</p>
                <div style="border:1px solid #e5e7eb;border-radius:8px;max-height:360px;overflow:auto;">
                    <table style="width:100%;border-collapse:collapse;font-size:14px;">
                        <thead style="background:#f9fafb;">
                            <tr>
                                <th style="padding:8px;text-align:left;">é»˜è®¤</th>
                                <th style="padding:8px;text-align:left;">è®¾å¤‡</th>
                                <th style="padding:8px;text-align:left;">ç±»å‹</th>
                                <th style="padding:8px;text-align:left;">åˆ«å</th>
                                <th style="padding:8px;text-align:left;">ç”¨é€”</th>
                                <th style="padding:8px;text-align:left;">æœ€è¿‘çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody id="remoteConfigTableBody">
                            <tr>
                                <td colspan="6" class="muted" style="padding:12px;text-align:center;">æ­£åœ¨åŠ è½½è®¾å¤‡ä¿¡æ¯...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="remoteConfigEmpty" class="muted" style="margin-top:12px;display:none;"></div>
                <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:18px;">
                    <button type="button" class="btn" onclick="closeRemoteConfigModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">æäº¤é…ç½®</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘ç¬”è®°æ¨¡æ€æ¡† -->
    <div class="modal" id="noteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="noteModalTitle">æ·»åŠ ç¬”è®°</h3>
                <button class="close-btn" onclick="closeNoteModal()">&times;</button>
            </div>
            <form id="noteForm">
                <div class="form-group">
                    <label>æ ‡é¢˜ *</label>
                    <input type="text" id="noteTitle" required placeholder="è¯·è¾“å…¥ç¬”è®°æ ‡é¢˜">
                </div>
                <div class="form-group">
                    <label>å†…å®¹</label>
                    <textarea id="noteContent" placeholder="è¯·è¾“å…¥ç¬”è®°å†…å®¹"></textarea>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeNoteModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success" id="noteSubmitBtn">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentShopId = null;
        let shops = [];
        let heartbeats = [];
        let heartbeatMap = {};
        let isEditingShop = false;
        let isEditingPrinter = false;
        let editingPrinterOriginalIp = null;
        let remoteConfigAgent = null;
        let remoteConfigPrinterMap = {};
        let notes = [];
        let isEditingNote = false;
        let editingNoteId = null;
        let isAuthenticated = false;

        // Check authentication status on page load
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check', {
                    credentials: 'include'
                });
                const data = await response.json();
                if (data.success && data.authenticated) {
                    isAuthenticated = true;
                    showMainApp();
                } else {
                    showLoginScreen();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            // Start data refresh after showing main app
            startDataRefresh();
        }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'ç™»å½•ä¸­...';
            errorDiv.textContent = '';

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                if (data.success) {
                    isAuthenticated = true;
                    showMainApp();
                } else {
                    errorDiv.textContent = data.error || 'ç™»å½•å¤±è´¥';
                }
            } catch (error) {
                errorDiv.textContent = 'ç™»å½•å¤±è´¥: ' + error.message;
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'ç™»å½•';
            }
        });

        // Logout handler
        async function handleLogout() {
            if (!confirm('ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();
                if (data.success) {
                    isAuthenticated = false;
                    showLoginScreen();
                    // Clear form
                    document.getElementById('loginForm').reset();
                    document.getElementById('loginError').textContent = '';
                } else {
                    showToast('ç™»å‡ºå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showToast('ç™»å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // Wrap API calls to handle 401 errors
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            const response = await originalFetch(...args);
            if (response.status === 401 && isAuthenticated) {
                // Session expired, redirect to login
                isAuthenticated = false;
                showLoginScreen();
                showToast('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
            }
            return response;
        };

        // Initialize
        checkAuth();

        const normalizePrinterType = (type) => {
            if (!type) return 'Kitchen';
            const cleaned = String(type).trim().toLowerCase();
            switch (cleaned) {
                case 'kitchen':
                    return 'Kitchen';
                case 'front':
                case 'frontdesk':
                    return 'FrontDesk';
                case 'bar':
                    return 'Bar';
                case 'receipt':
                    return 'Receipt';
                case 'label':
                    return 'Label';
                default:
                    return 'Kitchen';
            }
        };

        const printerTypeLabel = (type) => {
            const normalized = normalizePrinterType(type);
            const labelMap = {
                Kitchen: 'Kitchen',
                FrontDesk: 'FrontDesk',
                Bar: 'Bar',
                Receipt: 'Receipt',
                Label: 'Label'
            };
            return labelMap[normalized] || normalized;
        };

        function formatRelativeTime(isoString) {
            if (!isoString) return '--';
            const target = new Date(isoString).getTime();
            if (Number.isNaN(target)) return isoString;
            const diff = Date.now() - target;
            if (diff < 0) return 'åˆšåˆš';
            const seconds = Math.floor(diff / 1000);
            if (seconds < 60) return `${seconds} ç§’å‰`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} åˆ†é’Ÿå‰`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} å°æ—¶å‰`;
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days} å¤©å‰`;
            return new Date(isoString).toLocaleString();
        }

        function formatDateTime(isoString) {
            if (!isoString) return '--';
            try {
                return new Date(isoString).toLocaleString();
            } catch (error) {
                return isoString;
            }
        }

        function formatPrinterLabel(printer) {
            if (!printer) return 'æœªçŸ¥æ‰“å°æœº';
            if (printer.connectionType === 'tcp') {
                const host = printer.ip || printer.host || 'æœªçŸ¥åœ°å€';
                const port = printer.port || 9100;
                return `${host}:${port} Â· TCP`;
            }
            const vendor =
                typeof printer.vendorId === 'number'
                    ? `0x${printer.vendorId.toString(16)}`
                    : 'æœªçŸ¥';
            const product =
                typeof printer.productId === 'number'
                    ? `0x${printer.productId.toString(16)}`
                    : 'æœªçŸ¥';
            return `VID ${vendor} Â· PID ${product} Â· USB`;
        }

        function buildPrinterKey(printer) {
            if (!printer || typeof printer !== 'object') return '';
            if (printer.connectionType === 'tcp') {
                const host = printer.ip || printer.host;
                if (!host) return '';
                return `tcp:${host}:${Number(printer.port || 9100)}`;
            }
            if (typeof printer.vendorId === 'number' && typeof printer.productId === 'number') {
                return `usb:${Number(printer.vendorId)}:${Number(printer.productId)}`;
            }
            return '';
        }

        function escapeForAttribute(value = '') {
            return String(value)
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'");
        }

        // åŠ è½½å®¢æˆ·ç«¯ä¸‹è½½é“¾æ¥
        async function loadDownloadLinks() {
            try {
                const response = await fetch('/api/client-downloads', {
                    credentials: 'include'
                });
                const data = await response.json();
                const container = document.getElementById('download-links-container');
                
                if (!data.success || !data.downloads) {
                    container.innerHTML = '<span class="muted">æš‚æ— å¯ç”¨ä¸‹è½½</span>';
                    return;
                }
                
                const downloads = data.downloads;
                const links = [];
                
                // Windows ä¸‹è½½é“¾æ¥ï¼ˆåªæ˜¾ç¤ºä¾¿æºç‰ˆï¼‰
                if (downloads.win.zip) {
                    const version = downloads.win.version ? ` v${downloads.win.version}` : '';
                    links.push(`<a class="btn btn-small" href="${downloads.win.zip}" target="_blank" rel="noopener" download>ğŸªŸ Windows ä¾¿æºç‰ˆ (.zip)${version}</a>`);
                }
                
                // macOS ä¸‹è½½é“¾æ¥
                if (downloads.mac.dmg || downloads.mac.zip) {
                    const version = downloads.mac.version ? ` v${downloads.mac.version}` : '';
                    if (downloads.mac.dmg) {
                        links.push(`<a class="btn btn-small" href="${downloads.mac.dmg}" target="_blank" rel="noopener" download>ğŸ macOS å®‰è£…åŒ… (.dmg)${version}</a>`);
                    }
                    if (downloads.mac.zip) {
                        links.push(`<a class="btn btn-small" href="${downloads.mac.zip}" target="_blank" rel="noopener" download>ğŸ macOS å…å®‰è£… (.zip)${version}</a>`);
                    }
                }
                
                // Linux ä¸‹è½½é“¾æ¥
                if (downloads.linux.appimage || downloads.linux.deb) {
                    const version = downloads.linux.version ? ` v${downloads.linux.version}` : '';
                    if (downloads.linux.appimage) {
                        links.push(`<a class="btn btn-small" href="${downloads.linux.appimage}" target="_blank" rel="noopener" download>ğŸ§ Linux AppImage${version}</a>`);
                    }
                    if (downloads.linux.deb) {
                        links.push(`<a class="btn btn-small" href="${downloads.linux.deb}" target="_blank" rel="noopener" download>ğŸ§ Linux DEB${version}</a>`);
                    }
                }
                
                if (links.length === 0) {
                    container.innerHTML = '<span class="muted">æš‚æ— å¯ç”¨ä¸‹è½½</span>';
                } else {
                    container.innerHTML = links.join('');
                }
            } catch (error) {
                console.error('åŠ è½½ä¸‹è½½é“¾æ¥å¤±è´¥:', error);
                const container = document.getElementById('download-links-container');
                container.innerHTML = '<span class="muted">åŠ è½½å¤±è´¥</span>';
            }
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                const [shopsRes, agentsRes, heartbeatRes, notesRes] = await Promise.all([
                    fetch('/api/shops', { credentials: 'include' }),
                    fetch('/api/agents', { credentials: 'include' }),
                    fetch('/api/agent-heartbeat', { credentials: 'include' }),
                    fetch('/api/notes', { credentials: 'include' })
                ]);

                const shopsData = await shopsRes.json();
                const agentsData = await agentsRes.json();
                const heartbeatData = await heartbeatRes.json();
                const notesData = await notesRes.json();
                const heartbeatList = Array.isArray(heartbeatData.agents)
                    ? heartbeatData.agents
                    : Object.values(heartbeatData.agents || {});

                shops = shopsData.shops || [];
                heartbeats = heartbeatList;
                notes = notesData.notes || [];
                heartbeatMap = heartbeatList.reduce((acc, agent) => {
                    if (agent && agent.shopId) {
                        acc[agent.shopId] = agent;
                    }
                    return acc;
                }, {});

                updateStats(shopsData);
                updateHeartbeatStats(heartbeatData);
                renderShops(shops);
                renderHeartbeats(heartbeats);
                renderNotes(notes);
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showToast('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        function updateStats(data) {
            document.getElementById('totalShops').textContent = data.total || 0;
            document.getElementById('connectedShops').textContent = data.connected || 0;
            document.getElementById('disconnectedShops').textContent = (data.total || 0) - (data.connected || 0);
        }

        function updateHeartbeatStats(data) {
            const list = heartbeats || [];
            document.getElementById('heartbeatOnline').textContent = data.online || 0;
            document.getElementById('heartbeatOffline').textContent = data.offline || Math.max(0, (data.total || 0) - (data.online || 0));
            renderVersionStats(list);
            renderAlerts(list);
        }

        function renderVersionStats(list) {
            const summaryEl = document.getElementById('versionSummary');
            const detailEl = document.getElementById('versionDetail');
            if (!Array.isArray(list) || list.length === 0) {
                summaryEl.textContent = '--';
                detailEl.textContent = '';
                return;
            }
            const counter = {};
            list.forEach((agent) => {
                if (!agent || !agent.version) return;
                const key = agent.version;
                counter[key] = (counter[key] || 0) + 1;
            });
            const entries = Object.entries(counter).sort((a, b) => b[1] - a[1]);
            if (!entries.length) {
                summaryEl.textContent = 'æœªçŸ¥';
                detailEl.textContent = 'å°šæ— ç‰ˆæœ¬ä¸ŠæŠ¥';
                return;
            }
            const [topVersion, topCount] = entries[0];
            summaryEl.textContent = `v${topVersion}`;
            detailEl.textContent = entries.map(([version, count]) => `v${version}: ${count}`).join(' Â· ');
        }

        function renderAlerts(list) {
            const alertContainer = document.getElementById('alertsList');
            const alertCountEl = document.getElementById('alertCount');
            const alertDetailEl = document.getElementById('alertDetail');

            if (!Array.isArray(list) || !alertContainer) {
                alertContainer.textContent = 'æš‚æ— æ•°æ®';
                alertCountEl.textContent = '0';
                alertDetailEl.textContent = 'ç­‰å¾…å¿ƒè·³ä¸ŠæŠ¥';
                return;
            }

            const alerts = [];

            list.forEach((agent) => {
                if (!agent) return;
                if (!agent.online) {
                    alerts.push({
                        type: 'offline',
                        shopId: agent.shopId,
                        message: 'å¿ƒè·³ç¦»çº¿',
                        timestamp: agent.lastSeenAt
                    });
                }

                const printers = Array.isArray(agent.printers) ? agent.printers : [];
                const defaultPrinter = printers.find((printer) => printer && printer.isDefault);
                if (!defaultPrinter) {
                    alerts.push({
                        type: 'missing-default',
                        shopId: agent.shopId,
                        message: 'æœªè®¾ç½®é»˜è®¤æ‰“å°æœº',
                        timestamp: agent.lastSeenAt
                    });
                } else if (defaultPrinter.lastTest && defaultPrinter.lastTest.status === 'error') {
                    alerts.push({
                        type: 'test-failed',
                        shopId: agent.shopId,
                        message: defaultPrinter.lastTest.message || 'é»˜è®¤æ‰“å°æœºæœ€è¿‘æµ‹è¯•å¤±è´¥',
                        timestamp: defaultPrinter.lastTest.timestamp
                    });
                }

                if (Array.isArray(agent.logs)) {
                    const recentError = agent.logs.slice(-20).reverse().find((line) => /error|å¤±è´¥|fatal/i.test(line));
                    if (recentError) {
                        alerts.push({
                            type: 'log',
                            shopId: agent.shopId,
                            message: recentError,
                            timestamp: agent.lastSeenAt
                        });
                    }
                }
            });

            alertCountEl.textContent = alerts.length;
            alertDetailEl.textContent = alerts.length ? `æœ€è¿‘ ${alerts.length} æ¡å‘Šè­¦` : 'æš‚æ— å‘Šè­¦';

            if (!alerts.length) {
                alertContainer.innerHTML = '<div class="muted">æš‚æ— å¼‚å¸¸ï¼Œæ‰€æœ‰é—¨åº—çŠ¶æ€æ­£å¸¸ã€‚</div>';
                return;
            }

            alertContainer.innerHTML = alerts
                .slice(0, 20)
                .map((alert) => {
                    const time = alert.timestamp ? `${formatRelativeTime(alert.timestamp)} Â· ${formatDateTime(alert.timestamp)}` : 'æ—¶é—´æœªçŸ¥';
                    const displayMessage = summarizeAlertMessage(alert);
                    return `
                        <div style="background:#fef2f2;border-radius:8px;padding:12px;margin-bottom:10px;">
                            <strong style="color:#991b1b;">${alert.shopId}</strong>
                            <div style="margin-top:6px;color:#991b1b;">${displayMessage.title}</div>
                            ${displayMessage.details ? `<div class="muted" style="margin-top:6px;font-size:12px;">${displayMessage.details}</div>` : ''}
                            <div class="muted" style="margin-top:6px;font-size:12px;">${time}</div>
                        </div>
                    `;
                })
                .join('');
        }

        function summarizeAlertMessage(alert) {
            const clean = (text) => {
                if (!text) return '';
                const withoutHtml = text.replace(/<[^>]*>/g, ' ');
                return withoutHtml.replace(/\s+/g, ' ').trim();
            };

            if (alert.type === 'offline') {
                return { title: 'å¿ƒè·³ç¦»çº¿', details: 'è¯·æ£€æŸ¥é—¨åº—æœ¬åœ° Agent æ˜¯å¦è¿è¡Œã€ç½‘ç»œæ˜¯å¦æ­£å¸¸ã€‚' };
            }
            if (alert.type === 'missing-default') {
                return { title: 'æœªè®¾ç½®é»˜è®¤æ‰“å°æœº', details: 'å¯åœ¨é—¨åº—ç»ˆç«¯çš„ Agent ç•Œé¢å‹¾é€‰â€œé»˜è®¤â€åå†å°è¯•ã€‚' };
            }
            if (alert.type === 'test-failed') {
                return {
                    title: 'é»˜è®¤æ‰“å°æœºæœ€è¿‘æµ‹è¯•å¤±è´¥',
                    details: clean(alert.message)
                };
            }
            if (alert.type === 'log') {
                const msg = clean(alert.message);
                if (/Auto-update status/i.test(msg) && /Cannot parse update info/i.test(msg)) {
                    return {
                        title: 'è‡ªåŠ¨æ›´æ–°å‡ºé”™ï¼šæ— æ³•è§£ææ›´æ–°é…ç½®',
                        details: 'è¯·ç¡®è®¤æ›´æ–°æºä¸­å­˜åœ¨ latest-mac.ymlï¼ˆå½“å‰è¿”å› stable-mac.yml æˆ– HTMLï¼‰ï¼Œå¹¶ä¿æŒ Agent ç‰ˆæœ¬ä¸º 0.2.0 ä»¥ä¸Šã€‚'
                    };
                }
                return {
                    title: 'æ—¥å¿—å‘Šè­¦',
                    details: msg.length > 160 ? msg.slice(0, 160) + 'â€¦' : msg
                };
            }
            return { title: clean(alert.message), details: '' };
        }

        function getDefaultPrinter(agent) {
            if (!agent) return null;
            const printers = Array.isArray(agent.printers) ? agent.printers : [];
            return printers.find((printer) => printer && printer.isDefault) || null;
        }

        async function triggerRemoteTest(shopId, button) {
            if (button) {
                button.disabled = true;
                button.textContent = 'æµ‹è¯•ä¸­...';
            }
            try {
                const response = await fetch(`/api/agent-heartbeat/${encodeURIComponent(shopId)}/test-default`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });
                const result = await response.json();
                if (result.success) {
                    if (result.task && result.task.id) {
                        showToast(`å·²æ´¾å‘æµ‹è¯•ä»»åŠ¡ #${result.task.id}ï¼š${shopId}`, 'success');
                    } else {
                        showToast(`å·²å‘é€æµ‹è¯•æ‰“å°ï¼š${shopId}`, 'success');
                    }
                    setTimeout(loadData, 2000);
                } else {
                    showToast(`æµ‹è¯•å¤±è´¥ï¼š${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showToast('æµ‹è¯•å¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                if (button) {
                    button.disabled = false;
                    button.textContent = 'è¿œç¨‹æµ‹è¯•';
                }
            }
        }

        function renderHeartbeats(list) {
            const container = document.getElementById('heartbeatList');
            if (!container) return;

            if (!Array.isArray(list) || list.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æš‚æ— å¿ƒè·³æ•°æ®</div>';
            return;
            }

            container.innerHTML = list.map((agent) => {
                const statusClass = agent.online ? 'connected' : 'disconnected';
                const statusLabel = agent.online ? 'åœ¨çº¿' : 'ç¦»çº¿';
                const versionLabel = agent.version ? `v${agent.version}` : 'ç‰ˆæœ¬æœªçŸ¥';
                const platformLabel = agent.platform ? `${agent.platform}${agent.arch ? ` Â· ${agent.arch}` : ''}` : '';
                const serverStatus = agent.server?.running ? 'æœ¬åœ°æœåŠ¡è¿è¡Œä¸­' : 'æœ¬åœ°æœåŠ¡æœªè¿è¡Œ';
                const nextLine = [
                    versionLabel,
                    platformLabel,
                    `è®¾å¤‡ ${agent.devicesCount || 0} å°`,
                    agent.tcpPrinterCount !== undefined ? `TCP ${agent.tcpPrinterCount} å°` : ''
                ].filter(Boolean).join(' Â· ');
                const logPreview = Array.isArray(agent.logs) ? agent.logs.slice(-10) : [];
                const defaultPrinter = getDefaultPrinter(agent);
                const defaultInfo = defaultPrinter
                    ? `é»˜è®¤æ‰“å°æœºï¼š${formatPrinterLabel(defaultPrinter)}${defaultPrinter.alias ? ` Â· ${defaultPrinter.alias}` : ''}`
                    : 'æœªè®¾ç½®é»˜è®¤æ‰“å°æœº';
                const defaultStatus = defaultPrinter && defaultPrinter.lastTest
                    ? defaultPrinter.lastTest.status === 'success'
                        ? `<span class="status-badge connected">æœ€è¿‘æˆåŠŸ Â· ${formatRelativeTime(defaultPrinter.lastTest.timestamp)}</span>`
                        : `<span class="status-badge disconnected">æœ€è¿‘å¤±è´¥ Â· ${formatRelativeTime(defaultPrinter.lastTest.timestamp)}</span>`
                    : '';
                const history = Array.isArray(agent.history) ? agent.history.slice(0, 8) : [];
                const historyTable = history.length
                    ? `
                        <div class="history-block" style="margin-top:12px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                                <strong>æœ€è¿‘æ‰“å°è®°å½•</strong>
                                <span class="muted">${history.length} æ¡</span>
                            </div>
                            <div style="overflow-x:auto;">
                                <table style="width:100%;border-collapse:collapse;font-size:12px;">
                                    <thead style="background:#f3f4f6;">
                                        <tr>
                                            <th style="padding:6px 8px;text-align:left;color:#4b5563;">æ—¶é—´</th>
                                            <th style="padding:6px 8px;text-align:left;color:#4b5563;">è®¾å¤‡</th>
                                            <th style="padding:6px 8px;text-align:left;color:#4b5563;">çŠ¶æ€</th>
                                            <th style="padding:6px 8px;text-align:left;color:#4b5563;">è¯¦æƒ…</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${history
                                            .map((record) => {
                                                const statusClass = record.status === 'success' ? 'history-status-success' : 'history-status-error';
                                                const label =
                                                    record.connectionType === 'tcp'
                                                        ? `${record.ip || record.host || 'æœªçŸ¥åœ°å€'}:${record.port || 9100} Â· TCP`
                                                        : formatPrinterLabel(record);
                                                const detail = record.message || record.reason || '';
                                                return `
                                                    <tr>
                                                        <td style="padding:6px 8px;color:#111827;">${formatDateTime(record.timestamp)}</td>
                                                        <td style="padding:6px 8px;color:#374151;">${label}</td>
                                                        <td style="padding:6px 8px;">
                                                            <span class="${statusClass}">${record.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}</span>
                                                        </td>
                                                        <td style="padding:6px 8px;color:#6b7280;max-width:220px;word-break:break-all;">${detail}</td>
                                                    </tr>
                                                `;
                                            })
                                            .join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `
                    : '';
                return `
                    <div class="heartbeat-item">
                        <div class="heartbeat-top">
                            <div>
                                <strong>${agent.shopId}</strong>
                                ${agent.companyId ? `<span class="shop-id" style="margin-left:8px;background:#eef2ff;color:#3730a3;">å…¬å¸ ID: ${agent.companyId}</span>` : ''}
                            </div>
                            <span class="status-badge ${statusClass}">${statusLabel}</span>
                        </div>
                        <div class="muted">æœ€åå¿ƒè·³ï¼š${formatDateTime(agent.lastSeenAt)}ï¼ˆ${formatRelativeTime(agent.lastSeenAt)}ï¼‰</div>
                        <div class="muted" style="margin-top:4px;">${nextLine}</div>
                        <div class="muted" style="margin-top:4px;">${serverStatus} Â· ç«¯å£ ${agent.server?.port || 40713}</div>
                        <div class="muted" style="margin-top:4px; display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
                            ${defaultInfo}
                            ${defaultStatus}
                            <div style="margin-left:auto; display:flex; gap:6px;">
                                <button class="btn btn-small" ${agent.online && defaultPrinter ? '' : 'disabled'} onclick="triggerRemoteTest('${agent.shopId}', this)">è¿œç¨‹æµ‹è¯•</button>
                                <button class="btn btn-small btn-success" onclick="openRemoteConfig('${agent.shopId}')">è¿œç¨‹é…ç½®</button>
                            </div>
                        </div>
                        ${agent.remoteAddress ? `<div class="muted" style="margin-top:4px;">æ¥æº IPï¼š${agent.remoteAddress}</div>` : ''}
                        ${logPreview.length ? `
                            <details class="heartbeat-logs" style="margin-top:10px;">
                                <summary>æœ€è¿‘æ—¥å¿— (${logPreview.length} è¡Œ)</summary>
                                <pre>${logPreview.map(line => line.replace(/</g, '&lt;').replace(/>/g, '&gt;')).join('\\n')}</pre>
                            </details>
                        ` : ''}
                        ${historyTable}
                    </div>
                `;
            }).join('');
        }

        function openRemoteConfig(shopId) {
            const modal = document.getElementById('remoteConfigModal');
            const title = document.getElementById('remoteConfigTitle');
            const tbody = document.getElementById('remoteConfigTableBody');
            const emptyHint = document.getElementById('remoteConfigEmpty');
            if (!modal || !tbody) return;

            const agent = heartbeatMap[shopId];
            if (!agent) {
                showToast('æœªæ‰¾åˆ°è¯¥é—¨åº—çš„å¿ƒè·³æ•°æ®', 'error');
                return;
            }

            remoteConfigAgent = agent;
            remoteConfigPrinterMap = {};
            title.textContent = `è¿œç¨‹é…ç½® Â· ${shopId}`;

            const printers = Array.isArray(agent.printers) && agent.printers.length
                ? agent.printers
                : Array.isArray(agent.devices)
                    ? agent.devices
                    : [];

            if (!printers.length) {
                tbody.innerHTML = '';
                if (emptyHint) {
                    emptyHint.style.display = 'block';
                    emptyHint.textContent = 'è¯¥é—¨åº—å°šæœªä¸ŠæŠ¥æ‰“å°è®¾å¤‡ï¼Œæ— æ³•è¿œç¨‹é…ç½®ã€‚';
                }
            } else {
                if (emptyHint) {
                    emptyHint.style.display = 'none';
                }
                tbody.innerHTML = printers
                    .map((printer, index) => {
                        const key = buildPrinterKey(printer) || `printer-${index}`;
                        remoteConfigPrinterMap[key] = printer;
                        const alias = printer.alias || '';
                        const isDefault = Boolean(printer.isDefault);
                        const lastTest = printer.lastTest;
                        const lastStatus = lastTest
                            ? `<span class="${lastTest.status === 'success' ? 'history-status-success' : 'history-status-error'}">${lastTest.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}</span> Â· ${formatRelativeTime(lastTest.timestamp)}`
                            : '<span class="muted">æš‚æ— è®°å½•</span>';
                        const aliasValue = escapeForAttribute(alias);
                        return `
                            <tr>
                                <td style="padding:6px 8px;">
                                    <input type="radio" name="remote-default" value="${key}" ${isDefault ? 'checked' : ''}>
                                </td>
                                <td style="padding:6px 8px;">${formatPrinterLabel(printer)}</td>
                                <td style="padding:6px 8px;">${printer.connectionType === 'tcp' ? 'TCP' : 'USB'}</td>
                                <td style="padding:6px 8px;">
                                    <input class="remote-alias" data-key="${key}" type="text" value="${aliasValue}" placeholder="åˆ«å / ç”¨é€”" style="width:100%;padding:6px;border:1px solid #d1d5db;border-radius:6px;">
                                </td>
                                <td style="padding:6px 8px;">${printer.role || '--'}</td>
                                <td style="padding:6px 8px;">${lastStatus}</td>
                            </tr>
                        `;
                    })
                    .join('');
            }

            modal.classList.add('active');
        }

        function closeRemoteConfigModal() {
            const modal = document.getElementById('remoteConfigModal');
            if (modal) {
                modal.classList.remove('active');
            }
            remoteConfigAgent = null;
            remoteConfigPrinterMap = {};
            const form = document.getElementById('remoteConfigForm');
            if (form) {
                form.reset();
            }
        }

        async function submitRemoteConfig(event) {
            event.preventDefault();
            if (!remoteConfigAgent || !remoteConfigAgent.shopId) {
                showToast('æœªé€‰æ‹©éœ€è¦é…ç½®çš„é—¨åº—', 'error');
                return;
            }

            const form = event.target;
            const submitButton = form.querySelector('button[type="submit"]');
            const selected = form.querySelector('input[name="remote-default"]:checked');
            if (!selected) {
                showToast('è¯·é€‰æ‹©é»˜è®¤æ‰“å°æœº', 'error');
                return;
            }

            const aliasInputs = form.querySelectorAll('.remote-alias');
            const aliasMap = {};
            aliasInputs.forEach((input) => {
                aliasMap[input.dataset.key] = input.value || '';
            });

            const payload = { printerMappings: {} };
            Object.entries(remoteConfigPrinterMap).forEach(([key, printer]) => {
                const connectionType =
                    printer.connectionType ||
                    (typeof printer.vendorId === 'number' && typeof printer.productId === 'number' ? 'usb' : 'tcp');
                const entry = {
                    connectionType,
                    alias: aliasMap[key] ?? printer.alias ?? '',
                    role: printer.role || '',
                    isDefault: key === selected.value
                };
                if (connectionType === 'usb') {
                    entry.vendorId = Number(printer.vendorId);
                    entry.productId = Number(printer.productId);
                } else {
                    entry.ip = printer.ip || printer.host || '';
                    entry.port = Number(printer.port || 9100);
                }
                payload.printerMappings[key] = entry;
            });

            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = 'æäº¤ä¸­...';
            }

            fetch('/api/agent/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    shopId: remoteConfigAgent.shopId,
                    type: 'config',
                    payload
                })
            })
                .then(async (response) => {
                    let data = {};
                    if (response.headers.get('content-type')?.includes('application/json')) {
                        data = await response.json();
                    } else {
                        const text = await response.text();
                        throw new Error(text || 'è¿œç¨‹æ¥å£è¿”å›é JSON æ•°æ®');
                    }
                    if (data.success) {
                        showToast('è¿œç¨‹é…ç½®ä»»åŠ¡å·²ä¸‹å‘');
                        closeRemoteConfigModal();
                        setTimeout(loadData, 2000);
                    } else {
                        throw new Error(data.error || 'æœªçŸ¥é”™è¯¯');
                    }
                })
                .catch((error) => {
                    showToast('é…ç½®å¤±è´¥ï¼š' + (error?.message || error), 'error');
                })
                .finally(() => {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.textContent = 'æäº¤é…ç½®';
                    }
                });
        }

        function renderShops(shops) {
            const list = document.getElementById('shopList');
            if (shops.length === 0) {
                list.innerHTML = '<li style="text-align: center; color: #666; padding: 20px;">æš‚æ— åˆ†åº—ï¼Œç‚¹å‡»"æ·»åŠ åˆ†åº—"å¼€å§‹</li>';
                return;
            }

            list.innerHTML = shops.map(shop => {
                const printers = Array.isArray(shop.printers) ? shop.printers : [];
                const safeShopId = escapeForAttribute(shop.shopId || '');
                const heartbeat = heartbeatMap[shop.shopId] || null;
                const heartbeatBadge = heartbeat
                    ? `<span class="status-badge ${heartbeat.online ? 'connected' : 'disconnected'}" title="æœ€åå¿ƒè·³ï¼š${formatDateTime(heartbeat.lastSeenAt)}">${heartbeat.online ? 'å¿ƒè·³åœ¨çº¿' : 'å¿ƒè·³ç¦»çº¿'}</span>`
                    : '<span class="status-badge disconnected">æ— å¿ƒè·³</span>';
                const heartbeatInfo = heartbeat
                    ? `<div class="muted" style="margin-top:6px;">å¿ƒè·³ï¼š${formatRelativeTime(heartbeat.lastSeenAt)} Â· ${heartbeat.version ? `v${heartbeat.version}` : 'ç‰ˆæœ¬æœªçŸ¥'}</div>`
                    : '<div class="muted" style="margin-top:6px;">å¿ƒè·³ï¼šå°šæœªæ”¶åˆ°</div>';
                return `
                <li class="shop-item">
                    <div class="shop-header">
                        <div>
                            <div class="shop-name">${shop.name || shop.shopId}</div>
                            <div class="shop-id">${shop.shopId}</div>
                            ${shop.managerCompanyId ? `<div class="shop-id" style="margin-top:4px; background:#eef2ff; color:#3730a3;">å…¬å¸ ID: ${shop.managerCompanyId}</div>` : ''}
                            ${heartbeatInfo}
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="status-badge ${shop.connected ? 'connected' : 'disconnected'}">
                                ${shop.connected ? 'âœ“ å·²è¿æ¥' : 'âœ— æœªè¿æ¥'}
                            </span>
                            ${heartbeatBadge}
                            <button class="btn btn-small" onclick="showEditShopModal('${safeShopId}')">ç¼–è¾‘</button>
                        </div>
                    </div>
                    <div class="printers-list">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>æ‰“å°æœºåˆ—è¡¨ (${printers.length})</strong>
                            <div>
                                <button class="btn btn-small" onclick="showAddPrinterModal('${safeShopId}')">+ æ·»åŠ </button>
                                <button class="btn btn-small" onclick="showDeployModal('${safeShopId}')">éƒ¨ç½²</button>
                            </div>
                        </div>
                        ${printers.map(printer => {
                            const safePrinterIp = escapeForAttribute(printer.ip || '');
                            const printerPort = Number(printer.port) || 9100;
                            const displayName = printer.name ? printer.name : `${printer.ip}:${printerPort}`;
                            const displayType = printer.type ? ` (${printerTypeLabel(printer.type)})` : '';
                            return `
                            <div class="printer-item">
                                <div class="printer-info">
                                    <div class="printer-ip">${printer.ip}:${printerPort}</div>
                                    <div class="printer-name">${displayName}${displayType}</div>
                                </div>
                                <div class="printer-actions">
                                    <button class="btn btn-small" onclick="testPrinter(event, '${safeShopId}', '${safePrinterIp}', ${printerPort})">æµ‹è¯•</button>
                                    <button class="btn btn-small" onclick="showEditPrinterModal('${safeShopId}', '${safePrinterIp}')">ç¼–è¾‘</button>
                                    <button class="btn btn-small btn-danger" onclick="deletePrinter('${safeShopId}', '${safePrinterIp}')">åˆ é™¤</button>
                                </div>
                            </div>
                        `;
                        }).join('')}
                        ${printers.length === 0 ? '<div style="text-align: center; color: #999; padding: 10px;">æš‚æ— æ‰“å°æœº</div>' : ''}
                    </div>
                </li>
            `}).join('');
        }

        // æ·»åŠ åˆ†åº—
        function showAddShopModal() {
            document.getElementById('modalTitle').textContent = 'æ·»åŠ åˆ†åº—';
            document.getElementById('shopForm').reset();
            document.getElementById('shopId').disabled = false;
            const companyInput = document.getElementById('managerCompanyId');
            if (companyInput) {
                companyInput.value = '';
            }
            currentShopId = null;
            isEditingShop = false;
            document.getElementById('shopModal').classList.add('active');
        }

        function showEditShopModal(shopId) {
            const shop = shops.find(item => item.shopId === shopId);
            if (!shop) {
                showToast('åˆ†åº—ä¸å­˜åœ¨', 'error');
                return;
            }

            currentShopId = shopId;
            isEditingShop = true;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘åˆ†åº—';
            document.getElementById('shopForm').reset();
            const idInput = document.getElementById('shopId');
            idInput.value = shop.shopId;
            idInput.disabled = true;
            document.getElementById('shopName').value = shop.name || '';
            const companyInput = document.getElementById('managerCompanyId');
            if (companyInput) {
                companyInput.value = shop.managerCompanyId || '';
            }
            document.getElementById('shopModal').classList.add('active');
        }

        document.getElementById('shopForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const shopIdInput = document.getElementById('shopId').value.trim();
            const shopName = document.getElementById('shopName').value.trim();
            const managerCompanyId = document.getElementById('managerCompanyId').value.trim();

            if (!shopIdInput && !isEditingShop) {
                showToast('åˆ†åº—IDä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            try {
                const targetShopId = isEditingShop ? currentShopId : shopIdInput;

                if (!targetShopId) {
                    showToast('åˆ†åº—IDä¸èƒ½ä¸ºç©º', 'error');
                    return;
                }

                const url = isEditingShop ? `/api/shops/${targetShopId}` : '/api/shops';
                const method = isEditingShop ? 'PUT' : 'POST';
                const payload = isEditingShop
                    ? { name: shopName, managerCompanyId }
                    : { shopId: shopIdInput, name: shopName, managerCompanyId };

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (data.success) {
                    showToast(isEditingShop ? 'åˆ†åº—æ›´æ–°æˆåŠŸ' : 'åˆ†åº—æ·»åŠ æˆåŠŸ');
                    closeModal();
                    loadData();
                } else {
                    showToast((isEditingShop ? 'æ›´æ–°å¤±è´¥: ' : 'æ·»åŠ å¤±è´¥: ') + data.error, 'error');
                }
            } catch (error) {
                showToast((isEditingShop ? 'æ›´æ–°å¤±è´¥: ' : 'æ·»åŠ å¤±è´¥: ') + error.message, 'error');
            }
        });

        // æ·»åŠ æ‰“å°æœº
        function showAddPrinterModal(shopId) {
            currentShopId = shopId;
            isEditingPrinter = false;
            editingPrinterOriginalIp = null;
            document.getElementById('printerForm').reset();
            document.getElementById('printerPort').value = '9100';
            document.getElementById('printerModalTitle').textContent = 'æ·»åŠ æ‰“å°æœº';
            document.getElementById('printerSubmitBtn').textContent = 'æ·»åŠ ';
            document.getElementById('printerModal').classList.add('active');
        }

        function showEditPrinterModal(shopId, ip) {
            const shop = shops.find(item => item.shopId === shopId);
            if (!shop) {
                showToast('åˆ†åº—ä¸å­˜åœ¨', 'error');
                return;
            }

            const printers = Array.isArray(shop.printers) ? shop.printers : [];
            const printer = printers.find(item => item.ip === ip);
            if (!printer) {
                showToast('æ‰“å°æœºä¸å­˜åœ¨', 'error');
                return;
            }

            currentShopId = shopId;
            isEditingPrinter = true;
            editingPrinterOriginalIp = ip;

            document.getElementById('printerModalTitle').textContent = 'ç¼–è¾‘æ‰“å°æœº';
            document.getElementById('printerSubmitBtn').textContent = 'ä¿å­˜';
            document.getElementById('printerForm').reset();
            document.getElementById('printerIp').value = printer.ip || '';
            document.getElementById('printerPort').value = printer.port || '9100';
            document.getElementById('printerName').value = printer.name || '';
            const typeSelect = document.getElementById('printerType');
            const targetType = normalizePrinterType(printer.type);
            if (Array.from(typeSelect.options).some(option => option.value === targetType)) {
                typeSelect.value = targetType;
            } else {
                typeSelect.value = 'Kitchen';
            }

            document.getElementById('printerModal').classList.add('active');
        }

        document.getElementById('printerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const ip = document.getElementById('printerIp').value.trim();
            const portValue = parseInt(document.getElementById('printerPort').value, 10);
            const port = Number.isFinite(portValue) ? portValue : 9100;
            const name = document.getElementById('printerName').value.trim();
            const type = normalizePrinterType(document.getElementById('printerType').value);

            try {
                if (!currentShopId) {
                    showToast('è¯·é€‰æ‹©åˆ†åº—', 'error');
                    return;
                }

                if (!ip) {
                    showToast('IP åœ°å€ä¸èƒ½ä¸ºç©º', 'error');
                    return;
                }

                if (isEditingPrinter) {
                    const shop = shops.find(item => item.shopId === currentShopId);
                    if (!shop) {
                        showToast('åˆ†åº—ä¸å­˜åœ¨', 'error');
                        return;
                    }

                    const printers = Array.isArray(shop.printers) ? [...shop.printers] : [];
                    const printerIndex = printers.findIndex(item => item.ip === editingPrinterOriginalIp);

                    if (printerIndex === -1) {
                        showToast('æ‰“å°æœºä¸å­˜åœ¨', 'error');
                        return;
                    }

                    const updatedPrinter = {
                        ...printers[printerIndex],
                        ip,
                        port,
                        name: name || `${ip}:${port}`,
                        type
                    };

                    printers[printerIndex] = updatedPrinter;

                    const response = await fetch(`/api/shops/${currentShopId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ printers })
                    });

                    const data = await response.json();
                    if (data.success) {
                        showToast('æ‰“å°æœºæ›´æ–°æˆåŠŸ');
                        closePrinterModal();
                        loadData();
                    } else {
                        showToast('æ›´æ–°å¤±è´¥: ' + data.error, 'error');
                    }
                } else {
                    const response = await fetch(`/api/shops/${currentShopId}/printers`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ ip, port, name, type })
                    });

                    const data = await response.json();
                    if (data.success) {
                        showToast('æ‰“å°æœºæ·»åŠ æˆåŠŸ');
                        closePrinterModal();
                        loadData();
                    } else {
                        showToast('æ·»åŠ å¤±è´¥: ' + data.error, 'error');
                    }
                }
            } catch (error) {
                showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        });

        const remoteConfigForm = document.getElementById('remoteConfigForm');
        if (remoteConfigForm) {
            remoteConfigForm.addEventListener('submit', submitRemoteConfig);
        }

        // åˆ é™¤æ‰“å°æœº
        async function deletePrinter(shopId, ip) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ‰“å°æœº ${ip} å—ï¼Ÿ`)) return;

            try {
                const response = await fetch(`/api/shops/${shopId}/printers/${ip}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const data = await response.json();
                if (data.success) {
                    showToast('åˆ é™¤æˆåŠŸ');
                    loadData();
                } else {
                    showToast('åˆ é™¤å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•æ‰“å°æœº
        async function testPrinter(evt, shopId, ip, port) {
            const btn = evt?.target;
            if (!btn) {
                return;
            }

            const originalText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> æµ‹è¯•ä¸­...';

            try {
                const response = await fetch(`/api/shops/${shopId}/printers/${ip}/test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ port })
                });

                const data = await response.json();
                if (data.success) {
                    showToast('æµ‹è¯•æ‰“å°å·²å‘é€ï¼Œè¯·æ£€æŸ¥æ‰“å°æœº');
                } else {
                    showToast('æµ‹è¯•å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // æ˜¾ç¤ºéƒ¨ç½²è„šæœ¬
        async function showDeployModal(shopId) {
            document.getElementById('deployModal').classList.add('active');
            const wslEl = document.getElementById('deployCommandWsl');
            const macEl = document.getElementById('deployCommandMac');
            wslEl.textContent = 'åŠ è½½ä¸­...';
            macEl.textContent = 'åŠ è½½ä¸­...';
            delete wslEl.dataset.command;
            delete macEl.dataset.command;

            try {
                const response = await fetch(`/api/shops/${shopId}/deploy`, {
                    credentials: 'include'
                });
                const data = await response.json();
                if (data.success) {
                    const wslCommand = data.linuxCommand || data.curlCommand || data.commands?.default;
                    const macCommand = data.macCommand || data.commands?.mac;

                    if (wslCommand) {
                        wslEl.textContent = wslCommand;
                        wslEl.dataset.command = wslCommand;
                } else {
                        wslEl.textContent = 'æœªæä¾›éƒ¨ç½²å‘½ä»¤';
                    }

                    if (macCommand) {
                        macEl.textContent = macCommand;
                        macEl.dataset.command = macCommand;
                    } else {
                        macEl.textContent = 'æš‚æœªæä¾› macOS éƒ¨ç½²å‘½ä»¤';
                    }
                } else {
                    const msg = 'åŠ è½½å¤±è´¥: ' + data.error;
                    wslEl.textContent = msg;
                    macEl.textContent = msg;
                }
            } catch (error) {
                const msg = 'åŠ è½½å¤±è´¥: ' + error.message;
                wslEl.textContent = msg;
                macEl.textContent = msg;
            }
        }

        function copyDeployCommand(event, variant = 'wsl') {
            const targetId = variant === 'mac' ? 'deployCommandMac' : 'deployCommandWsl';
            const commandEl = document.getElementById(targetId);
            if (!commandEl) {
                showToast('å¤åˆ¶å¤±è´¥ï¼Œæœªæ‰¾åˆ°å‘½ä»¤åŒºåŸŸ', 'error');
                return;
            }

            const command = commandEl.dataset.command || commandEl.textContent.trim();
            if (command === 'åŠ è½½ä¸­...' || !command || command.startsWith('åŠ è½½å¤±è´¥')) {
                showToast('å‘½ä»¤å°šæœªåŠ è½½å®Œæˆ', 'error');
                return;
            }
            
                    const btn = event ? event.target : document.querySelector('#deployModal .copy-btn');

            const handleSuccess = () => {
                    if (btn) {
                        const originalText = btn.textContent;
                        btn.textContent = 'å·²å¤åˆ¶!';
                        btn.classList.add('copied');
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.classList.remove('copied');
                        }, 2000);
                    }
                    showToast('å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            };

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(command).then(handleSuccess).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopy(command, btn);
                });
            } else {
                fallbackCopy(command, btn);
            }
        }
        
        // Fallback å¤åˆ¶æ–¹æ³•
        function fallbackCopy(text, context) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (!successful) {
                    showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶', 'error');
                    return;
                }
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶', 'error');
                return;
            } finally {
                document.body.removeChild(textArea);
            }

            if (typeof context === 'function') {
                context();
                return;
            }

            if (context) {
                const originalText = context.textContent;
                context.textContent = 'å·²å¤åˆ¶!';
                context.classList.add('copied');
                setTimeout(() => {
                    context.textContent = originalText;
                    context.classList.remove('copied');
                }, 2000);
            }
            showToast('å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }

        function closeModal() {
            document.getElementById('shopModal').classList.remove('active');
            document.getElementById('shopForm').reset();
            const idInput = document.getElementById('shopId');
            idInput.disabled = false;
            document.getElementById('modalTitle').textContent = 'æ·»åŠ åˆ†åº—';
            currentShopId = null;
            isEditingShop = false;
        }

        function closePrinterModal() {
            document.getElementById('printerModal').classList.remove('active');
            document.getElementById('printerForm').reset();
            document.getElementById('printerPort').value = '9100';
            currentShopId = null;
            isEditingPrinter = false;
            editingPrinterOriginalIp = null;
            document.getElementById('printerModalTitle').textContent = 'æ·»åŠ æ‰“å°æœº';
            document.getElementById('printerSubmitBtn').textContent = 'æ·»åŠ ';
        }

        function closeDeployModal() {
            document.getElementById('deployModal').classList.remove('active');
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = type === 'error' ? '#ef4444' : '#10b981';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function copyTextToClipboard({ event, text, onSuccess }) {
            const doCopy = (content) => {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(content).then(onSuccess).catch(() => fallbackCopy(content, onSuccess))
                } else {
                    fallbackCopy(content, onSuccess)
                }
            }

            doCopy(text)

            if (event) {
                event.preventDefault()
            }
        }

        function copyWSLFixCommand(event) {
            const commandEl = document.getElementById('wslFixCommand');
            const command = commandEl ? commandEl.textContent.trim() : 'curl -s https://pa.easyify.uk/fix-wsl-network.sh | bash';
            const onSuccess = () => {
                const btn = event ? event.target : document.querySelector('#wslFixCommand').parentElement.querySelector('.copy-btn');
                if (btn) {
                    const originalText = btn.textContent;
                    btn.textContent = 'å·²å¤åˆ¶!';
                    btn.style.background = '#10b981';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#374151';
                    }, 2000);
                }
                showToast('å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }

            copyTextToClipboard({ event, text: command, onSuccess })
        }

        window.triggerRemoteTest = triggerRemoteTest;

        function copyRestDeskInfo(event) {
            const info = document.getElementById('restDeskInfo');
            const text = info ? info.textContent.trim() : '';
            const onSuccess = () => {
                const btn = event ? event.target : document.querySelector('#restDeskInfo').parentElement.querySelector('.copy-btn');
                if (btn) {
                    const originalText = btn.textContent;
                    btn.textContent = 'å·²å¤åˆ¶!';
                    btn.style.background = '#4c1d95';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#4c1d95';
                    }, 2000);
                }
                showToast('RestDesk ä¿¡æ¯å·²å¤åˆ¶');
            }

            copyTextToClipboard({ event, text, onSuccess })
        }

        // ç¬”è®°ç®¡ç†åŠŸèƒ½
        function renderNotes(notesList) {
            const container = document.getElementById('notesList');
            if (!container) return;

            if (!Array.isArray(notesList) || notesList.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æš‚æ— ç¬”è®°ï¼Œç‚¹å‡»"æ·»åŠ ç¬”è®°"å¼€å§‹</div>';
                return;
            }

            // æŒ‰æ›´æ–°æ—¶é—´å€’åºæ’åˆ—
            const sortedNotes = [...notesList].sort((a, b) => {
                const aTime = new Date(a.updatedAt || a.createdAt || 0).getTime();
                const bTime = new Date(b.updatedAt || b.createdAt || 0).getTime();
                return bTime - aTime;
            });

            container.innerHTML = sortedNotes.map((note) => {
                const safeId = escapeForAttribute(note.id || '');
                const safeTitle = (note.title || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const safeContent = (note.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const createdAt = formatDateTime(note.createdAt);
                const updatedAt = formatDateTime(note.updatedAt);
                const isUpdated = note.updatedAt && note.createdAt && note.updatedAt !== note.createdAt;

                return `
                    <div class="note-item">
                        <div class="note-header">
                            <div style="flex: 1;">
                                <div class="note-title">${safeTitle}</div>
                                ${safeContent ? `<div class="note-content">${safeContent}</div>` : ''}
                                <div class="note-meta">
                                    åˆ›å»ºäº: ${createdAt}
                                    ${isUpdated ? ` Â· æ›´æ–°äº: ${updatedAt}` : ''}
                                </div>
                            </div>
                            <div class="note-actions">
                                <button class="btn btn-small" onclick="showEditNoteModal('${safeId}')">ç¼–è¾‘</button>
                                <button class="btn btn-small btn-danger" onclick="deleteNote('${safeId}')">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAddNoteModal() {
            document.getElementById('noteModalTitle').textContent = 'æ·»åŠ ç¬”è®°';
            document.getElementById('noteForm').reset();
            editingNoteId = null;
            isEditingNote = false;
            document.getElementById('noteModal').classList.add('active');
        }

        function showEditNoteModal(noteId) {
            const note = notes.find(item => item.id === noteId);
            if (!note) {
                showToast('ç¬”è®°ä¸å­˜åœ¨', 'error');
                return;
            }

            editingNoteId = noteId;
            isEditingNote = true;
            document.getElementById('noteModalTitle').textContent = 'ç¼–è¾‘ç¬”è®°';
            document.getElementById('noteForm').reset();
            document.getElementById('noteTitle').value = note.title || '';
            document.getElementById('noteContent').value = note.content || '';
            document.getElementById('noteModal').classList.add('active');
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
            document.getElementById('noteForm').reset();
            editingNoteId = null;
            isEditingNote = false;
            document.getElementById('noteModalTitle').textContent = 'æ·»åŠ ç¬”è®°';
        }

        document.getElementById('noteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();

            if (!title) {
                showToast('æ ‡é¢˜ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            try {
                if (isEditingNote && editingNoteId) {
                    // æ›´æ–°ç¬”è®°
                    const response = await fetch(`/api/notes/${editingNoteId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ title, content })
                    });

                    const data = await response.json();
                    if (data.success) {
                        showToast('ç¬”è®°æ›´æ–°æˆåŠŸ');
                        closeNoteModal();
                        loadData();
                    } else {
                        showToast('æ›´æ–°å¤±è´¥: ' + data.error, 'error');
                    }
                } else {
                    // åˆ›å»ºç¬”è®°
                    const response = await fetch('/api/notes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ title, content })
                    });

                    const data = await response.json();
                    if (data.success) {
                        showToast('ç¬”è®°æ·»åŠ æˆåŠŸ');
                        closeNoteModal();
                        loadData();
                    } else {
                        showToast('æ·»åŠ å¤±è´¥: ' + data.error, 'error');
                    }
                }
            } catch (error) {
                showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        });

        async function deleteNote(noteId) {
            const note = notes.find(item => item.id === noteId);
            if (!note) {
                showToast('ç¬”è®°ä¸å­˜åœ¨', 'error');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç¬”è®° "${note.title}" å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`/api/notes/${noteId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const data = await response.json();
                if (data.success) {
                    showToast('åˆ é™¤æˆåŠŸ');
                    loadData();
                } else {
                    showToast('åˆ é™¤å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å®šæœŸåˆ·æ–°æ•°æ®ï¼ˆä»…åœ¨å·²ç™»å½•æ—¶ï¼‰
        function startDataRefresh() {
            if (!isAuthenticated) return;
            
            loadDownloadLinks();
            loadData();
            setInterval(() => {
                if (isAuthenticated) {
                    loadData();
                }
            }, 5000);
            // ä¸‹è½½é“¾æ¥æ¯30ç§’åˆ·æ–°ä¸€æ¬¡ï¼ˆå› ä¸ºæ›´æ–°é¢‘ç‡è¾ƒä½ï¼‰
            setInterval(() => {
                if (isAuthenticated) {
                    loadDownloadLinks();
                }
            }, 30000);
        }

        // Initialize on page load
        checkAuth();
    </script>
</body>
</html>


