<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“å°ä»£ç†ç®¡ç†åå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            color: #333;
            font-size: 32px;
            font-weight: bold;
        }

        .stat-card .value.connected {
            color: #10b981;
        }

        .stat-card .value.disconnected {
            color: #ef4444;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .shop-list {
            list-style: none;
        }

        .shop-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: box-shadow 0.3s;
        }

        .shop-item:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .shop-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .shop-id {
            font-size: 12px;
            color: #666;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-badge.connected {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        .printers-list {
            margin-top: 15px;
        }

        .printer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .printer-info {
            flex: 1;
        }

        .printer-ip {
            font-weight: bold;
            color: #333;
        }

        .printer-name {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .printer-actions {
            display: flex;
            gap: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 24px;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .deploy-command {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 15px 0;
            word-break: break-all;
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #374151;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .copy-btn:hover {
            background: #4b5563;
        }

        .copy-btn.copied {
            background: #10b981;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            
            <div style="margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                <strong>ğŸ–¥ï¸ RestDesk è¿œç¨‹è¿ç»´ä¿¡æ¯</strong>
                <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">
                    åœ¨åˆ†åº—ç”µè„‘ä¸Šå®‰è£… RestDesk åï¼Œå¡«å†™ä»¥ä¸‹é…ç½®å³å¯è¿æ¥ï¼š
                </p>
                <div style="margin-top: 10px; background: #1f2937; color: #f8fafc; padding: 12px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 13px; word-break: break-all; position: relative;">
                    <button class="copy-btn" onclick="copyRestDeskInfo(event)" style="position: absolute; top: 10px; right: 10px; background: #4c1d95; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; z-index: 10;">å¤åˆ¶</button>
                    <div id="restDeskInfo" style="padding-right: 80px; line-height: 1.6;">
IDæœåŠ¡å™¨: 90.195.120.165:21116
ä¸­ç»§æœåŠ¡å™¨: 90.195.120.165:21117
å¯†é’¥: VhrFMc1CL7jkcVmcwxdXI6KSkmRa6fuDtWKKM60vc1Q=
                    </div>
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>æ€»åˆ†åº—æ•°</h3>
                <div class="value" id="totalShops">0</div>
            </div>
            <div class="stat-card">
                <h3>å·²è¿æ¥</h3>
                <div class="value connected" id="connectedShops">0</div>
            </div>
            <div class="stat-card">
                <h3>æœªè¿æ¥</h3>
                <div class="value disconnected" id="disconnectedShops">0</div>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>
                    åˆ†åº—åˆ—è¡¨
                    <button class="btn btn-success" onclick="showAddShopModal()">+ æ·»åŠ åˆ†åº—</button>
                </h2>
                <ul class="shop-list" id="shopList">
                    <li>åŠ è½½ä¸­...</li>
                </ul>
            </div>

            <div class="card">
                <h2>å·²è¿æ¥ä»£ç†</h2>
                <div id="agentsList">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘åˆ†åº—æ¨¡æ€æ¡† -->
    <div class="modal" id="shopModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">æ·»åŠ åˆ†åº—</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="shopForm">
                <div class="form-group">
                    <label>åˆ†åº—ID *</label>
                    <input type="text" id="shopId" required placeholder="ä¾‹å¦‚: shop1, bbq">
                </div>
                <div class="form-group">
                    <label>åˆ†åº—åç§°</label>
                    <input type="text" id="shopName" placeholder="ä¾‹å¦‚: æµ‹è¯•åˆ†åº—">
                </div>
                <div class="form-group">
                    <label>å…³è”å…¬å¸ IDï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="managerCompanyId" placeholder="ä¾‹å¦‚: 27">
                    <p style="margin-top: 6px; font-size: 12px; color: #6b7280;">
                        ä¸ manager_next çš„ companyId å¯¹åº”ï¼Œæ–¹ä¾¿è‡ªåŠ¨ç”Ÿæˆ NEXT_PUBLIC_PRINT_AGENT_MAPã€‚
                    </p>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ·»åŠ æ‰“å°æœºæ¨¡æ€æ¡† -->
    <div class="modal" id="printerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="printerModalTitle">æ·»åŠ æ‰“å°æœº</h3>
                <button class="close-btn" onclick="closePrinterModal()">&times;</button>
            </div>
            <form id="printerForm">
                <div class="form-group">
                    <label>IP åœ°å€ *</label>
                    <input type="text" id="printerIp" required placeholder="ä¾‹å¦‚: 192.168.0.31">
                </div>
                <div class="form-group">
                    <label>ç«¯å£</label>
                    <input type="number" id="printerPort" value="9100" placeholder="9100">
                </div>
                <div class="form-group">
                    <label>æ‰“å°æœºåç§°</label>
                    <input type="text" id="printerName" placeholder="ä¾‹å¦‚: å¨æˆ¿æ‰“å°æœº1">
                </div>
                <div class="form-group">
                    <label>ç±»å‹</label>
                    <select id="printerType">
                        <option value="Kitchen">Kitchen</option>
                        <option value="FrontDesk">FrontDesk</option>
                        <option value="Bar">Bar</option>
                        <option value="Receipt">Receipt</option>
                        <option value="Label">Label</option>
                    </select>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closePrinterModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success" id="printerSubmitBtn">æ·»åŠ </button>
                </div>
            </form>
        </div>
    </div>

    <!-- éƒ¨ç½²è„šæœ¬æ¨¡æ€æ¡† -->
    <div class="modal" id="deployModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ä¸€é”®éƒ¨ç½²è„šæœ¬</h3>
                <button class="close-btn" onclick="closeDeployModal()">&times;</button>
            </div>
            <div>
                <p style="margin-bottom: 15px; color: #666;">é€‰æ‹©å¯¹åº”ç¯å¢ƒè¿è¡Œå‘½ä»¤ï¼š</p>
                <div class="space-y-4">
                    <div>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <strong>WSL / Linux</strong>
                            <span style="font-size:12px;color:#6b7280;">é»˜è®¤éƒ¨ç½²è„šæœ¬</span>
                        </div>
                        <div class="deploy-command">
                            <button class="copy-btn" onclick="copyDeployCommand(event, 'wsl')">å¤åˆ¶</button>
                            <div id="deployCommandWsl" style="padding-right: 80px;">åŠ è½½ä¸­...</div>
                        </div>
                    </div>
                    <div>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <strong>macOS</strong>
                            <span style="font-size:12px;color:#6b7280;">æœ¬åœ°è°ƒè¯•æˆ–åº—å†… Mac è®¾å¤‡</span>
                        </div>
                        <div class="deploy-command">
                            <button class="copy-btn" onclick="copyDeployCommand(event, 'mac')">å¤åˆ¶</button>
                            <div id="deployCommandMac" style="padding-right: 80px;">åŠ è½½ä¸­...</div>
                        </div>
                    </div>
                </div>
                <p style="margin-top: 15px; color: #666; font-size: 14px;">
                    ğŸ’¡ æç¤ºï¼šåœ¨å¯¹åº”ç¯å¢ƒçš„ç»ˆç«¯ä¸­ç²˜è´´å‘½ä»¤å¹¶è¿è¡Œå³å¯å®Œæˆéƒ¨ç½²ï¼›macOS è„šæœ¬ä¼šæ£€æµ‹ Node.js å¹¶æç¤ºä½¿ç”¨ Homebrew å®‰è£…ã€‚
                </p>
            </div>
        </div>
    </div>

    <script>
        let currentShopId = null;
        let shops = [];
        let isEditingShop = false;
        let isEditingPrinter = false;
        let editingPrinterOriginalIp = null;

        const normalizePrinterType = (type) => {
            if (!type) return 'Kitchen';
            const cleaned = String(type).trim().toLowerCase();
            switch (cleaned) {
                case 'kitchen':
                    return 'Kitchen';
                case 'front':
                case 'frontdesk':
                    return 'FrontDesk';
                case 'bar':
                    return 'Bar';
                case 'receipt':
                    return 'Receipt';
                case 'label':
                    return 'Label';
                default:
                    return 'Kitchen';
            }
        };

        const printerTypeLabel = (type) => {
            const normalized = normalizePrinterType(type);
            const labelMap = {
                Kitchen: 'Kitchen',
                FrontDesk: 'FrontDesk',
                Bar: 'Bar',
                Receipt: 'Receipt',
                Label: 'Label'
            };
            return labelMap[normalized] || normalized;
        };

        function escapeForAttribute(value = '') {
            return String(value)
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'");
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                const [shopsRes, agentsRes] = await Promise.all([
                    fetch('/api/shops'),
                    fetch('/api/agents')
                ]);

                const shopsData = await shopsRes.json();
                const agentsData = await agentsRes.json();

                shops = shopsData.shops || [];
                updateStats(shopsData);
                renderShops(shops);
                renderAgents(agentsData.agents || []);
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showToast('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        function updateStats(data) {
            document.getElementById('totalShops').textContent = data.total || 0;
            document.getElementById('connectedShops').textContent = data.connected || 0;
            document.getElementById('disconnectedShops').textContent = (data.total || 0) - (data.connected || 0);
        }

        function renderShops(shops) {
            const list = document.getElementById('shopList');
            if (shops.length === 0) {
                list.innerHTML = '<li style="text-align: center; color: #666; padding: 20px;">æš‚æ— åˆ†åº—ï¼Œç‚¹å‡»"æ·»åŠ åˆ†åº—"å¼€å§‹</li>';
                return;
            }

            list.innerHTML = shops.map(shop => {
                const printers = Array.isArray(shop.printers) ? shop.printers : [];
                const safeShopId = escapeForAttribute(shop.shopId || '');
                return `
                <li class="shop-item">
                    <div class="shop-header">
                        <div>
                            <div class="shop-name">${shop.name || shop.shopId}</div>
                            <div class="shop-id">${shop.shopId}</div>
                            ${shop.managerCompanyId ? `<div class="shop-id" style="margin-top:4px; background:#eef2ff; color:#3730a3;">å…¬å¸ ID: ${shop.managerCompanyId}</div>` : ''}
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="status-badge ${shop.connected ? 'connected' : 'disconnected'}">
                                ${shop.connected ? 'âœ“ å·²è¿æ¥' : 'âœ— æœªè¿æ¥'}
                            </span>
                            <button class="btn btn-small" onclick="showEditShopModal('${safeShopId}')">ç¼–è¾‘</button>
                        </div>
                    </div>
                    <div class="printers-list">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>æ‰“å°æœºåˆ—è¡¨ (${printers.length})</strong>
                            <div>
                                <button class="btn btn-small" onclick="showAddPrinterModal('${safeShopId}')">+ æ·»åŠ </button>
                                <button class="btn btn-small" onclick="showDeployModal('${safeShopId}')">éƒ¨ç½²</button>
                            </div>
                        </div>
                        ${printers.map(printer => {
                            const safePrinterIp = escapeForAttribute(printer.ip || '');
                            const printerPort = Number(printer.port) || 9100;
                            const displayName = printer.name ? printer.name : `${printer.ip}:${printerPort}`;
                            const displayType = printer.type ? ` (${printerTypeLabel(printer.type)})` : '';
                            return `
                            <div class="printer-item">
                                <div class="printer-info">
                                    <div class="printer-ip">${printer.ip}:${printerPort}</div>
                                    <div class="printer-name">${displayName}${displayType}</div>
                                </div>
                                <div class="printer-actions">
                                    <button class="btn btn-small" onclick="testPrinter(event, '${safeShopId}', '${safePrinterIp}', ${printerPort})">æµ‹è¯•</button>
                                    <button class="btn btn-small" onclick="showEditPrinterModal('${safeShopId}', '${safePrinterIp}')">ç¼–è¾‘</button>
                                    <button class="btn btn-small btn-danger" onclick="deletePrinter('${safeShopId}', '${safePrinterIp}')">åˆ é™¤</button>
                                </div>
                            </div>
                        `;
                        }).join('')}
                        ${printers.length === 0 ? '<div style="text-align: center; color: #999; padding: 10px;">æš‚æ— æ‰“å°æœº</div>' : ''}
                    </div>
                </li>
            `}).join('');
        }

        function renderAgents(agents) {
            const list = document.getElementById('agentsList');
            if (agents.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æš‚æ— å·²è¿æ¥çš„ä»£ç†</div>';
                return;
            }

            list.innerHTML = agents.map(agent => `
                <div style="padding: 15px; background: #f9fafb; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${agent.shopId}</strong>
                            <span class="status-badge ${agent.connected ? 'connected' : 'disconnected'}" style="margin-left: 10px;">
                                ${agent.connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ·»åŠ åˆ†åº—
        function showAddShopModal() {
            document.getElementById('modalTitle').textContent = 'æ·»åŠ åˆ†åº—';
            document.getElementById('shopForm').reset();
            document.getElementById('shopId').disabled = false;
            const companyInput = document.getElementById('managerCompanyId');
            if (companyInput) {
                companyInput.value = '';
            }
            currentShopId = null;
            isEditingShop = false;
            document.getElementById('shopModal').classList.add('active');
        }

        function showEditShopModal(shopId) {
            const shop = shops.find(item => item.shopId === shopId);
            if (!shop) {
                showToast('åˆ†åº—ä¸å­˜åœ¨', 'error');
                return;
            }

            currentShopId = shopId;
            isEditingShop = true;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘åˆ†åº—';
            document.getElementById('shopForm').reset();
            const idInput = document.getElementById('shopId');
            idInput.value = shop.shopId;
            idInput.disabled = true;
            document.getElementById('shopName').value = shop.name || '';
            const companyInput = document.getElementById('managerCompanyId');
            if (companyInput) {
                companyInput.value = shop.managerCompanyId || '';
            }
            document.getElementById('shopModal').classList.add('active');
        }

        document.getElementById('shopForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const shopIdInput = document.getElementById('shopId').value.trim();
            const shopName = document.getElementById('shopName').value.trim();
            const managerCompanyId = document.getElementById('managerCompanyId').value.trim();

            if (!shopIdInput && !isEditingShop) {
                showToast('åˆ†åº—IDä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            try {
                const targetShopId = isEditingShop ? currentShopId : shopIdInput;

                if (!targetShopId) {
                    showToast('åˆ†åº—IDä¸èƒ½ä¸ºç©º', 'error');
                    return;
                }

                const url = isEditingShop ? `/api/shops/${targetShopId}` : '/api/shops';
                const method = isEditingShop ? 'PUT' : 'POST';
                const payload = isEditingShop
                    ? { name: shopName, managerCompanyId }
                    : { shopId: shopIdInput, name: shopName, managerCompanyId };

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (data.success) {
                    showToast(isEditingShop ? 'åˆ†åº—æ›´æ–°æˆåŠŸ' : 'åˆ†åº—æ·»åŠ æˆåŠŸ');
                    closeModal();
                    loadData();
                } else {
                    showToast((isEditingShop ? 'æ›´æ–°å¤±è´¥: ' : 'æ·»åŠ å¤±è´¥: ') + data.error, 'error');
                }
            } catch (error) {
                showToast((isEditingShop ? 'æ›´æ–°å¤±è´¥: ' : 'æ·»åŠ å¤±è´¥: ') + error.message, 'error');
            }
        });

        // æ·»åŠ æ‰“å°æœº
        function showAddPrinterModal(shopId) {
            currentShopId = shopId;
            isEditingPrinter = false;
            editingPrinterOriginalIp = null;
            document.getElementById('printerForm').reset();
            document.getElementById('printerPort').value = '9100';
            document.getElementById('printerModalTitle').textContent = 'æ·»åŠ æ‰“å°æœº';
            document.getElementById('printerSubmitBtn').textContent = 'æ·»åŠ ';
            document.getElementById('printerModal').classList.add('active');
        }

        function showEditPrinterModal(shopId, ip) {
            const shop = shops.find(item => item.shopId === shopId);
            if (!shop) {
                showToast('åˆ†åº—ä¸å­˜åœ¨', 'error');
                return;
            }

            const printers = Array.isArray(shop.printers) ? shop.printers : [];
            const printer = printers.find(item => item.ip === ip);
            if (!printer) {
                showToast('æ‰“å°æœºä¸å­˜åœ¨', 'error');
                return;
            }

            currentShopId = shopId;
            isEditingPrinter = true;
            editingPrinterOriginalIp = ip;

            document.getElementById('printerModalTitle').textContent = 'ç¼–è¾‘æ‰“å°æœº';
            document.getElementById('printerSubmitBtn').textContent = 'ä¿å­˜';
            document.getElementById('printerForm').reset();
            document.getElementById('printerIp').value = printer.ip || '';
            document.getElementById('printerPort').value = printer.port || '9100';
            document.getElementById('printerName').value = printer.name || '';
            const typeSelect = document.getElementById('printerType');
            const targetType = normalizePrinterType(printer.type);
            if (Array.from(typeSelect.options).some(option => option.value === targetType)) {
                typeSelect.value = targetType;
            } else {
                typeSelect.value = 'Kitchen';
            }

            document.getElementById('printerModal').classList.add('active');
        }

        document.getElementById('printerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const ip = document.getElementById('printerIp').value.trim();
            const portValue = parseInt(document.getElementById('printerPort').value, 10);
            const port = Number.isFinite(portValue) ? portValue : 9100;
            const name = document.getElementById('printerName').value.trim();
            const type = normalizePrinterType(document.getElementById('printerType').value);

            try {
                if (!currentShopId) {
                    showToast('è¯·é€‰æ‹©åˆ†åº—', 'error');
                    return;
                }

                if (!ip) {
                    showToast('IP åœ°å€ä¸èƒ½ä¸ºç©º', 'error');
                    return;
                }

                if (isEditingPrinter) {
                    const shop = shops.find(item => item.shopId === currentShopId);
                    if (!shop) {
                        showToast('åˆ†åº—ä¸å­˜åœ¨', 'error');
                        return;
                    }

                    const printers = Array.isArray(shop.printers) ? [...shop.printers] : [];
                    const printerIndex = printers.findIndex(item => item.ip === editingPrinterOriginalIp);

                    if (printerIndex === -1) {
                        showToast('æ‰“å°æœºä¸å­˜åœ¨', 'error');
                        return;
                    }

                    const updatedPrinter = {
                        ...printers[printerIndex],
                        ip,
                        port,
                        name: name || `${ip}:${port}`,
                        type
                    };

                    printers[printerIndex] = updatedPrinter;

                    const response = await fetch(`/api/shops/${currentShopId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ printers })
                    });

                    const data = await response.json();
                    if (data.success) {
                        showToast('æ‰“å°æœºæ›´æ–°æˆåŠŸ');
                        closePrinterModal();
                        loadData();
                    } else {
                        showToast('æ›´æ–°å¤±è´¥: ' + data.error, 'error');
                    }
                } else {
                    const response = await fetch(`/api/shops/${currentShopId}/printers`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ip, port, name, type })
                    });

                    const data = await response.json();
                    if (data.success) {
                        showToast('æ‰“å°æœºæ·»åŠ æˆåŠŸ');
                        closePrinterModal();
                        loadData();
                    } else {
                        showToast('æ·»åŠ å¤±è´¥: ' + data.error, 'error');
                    }
                }
            } catch (error) {
                showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        });

        // åˆ é™¤æ‰“å°æœº
        async function deletePrinter(shopId, ip) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ‰“å°æœº ${ip} å—ï¼Ÿ`)) return;

            try {
                const response = await fetch(`/api/shops/${shopId}/printers/${ip}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.success) {
                    showToast('åˆ é™¤æˆåŠŸ');
                    loadData();
                } else {
                    showToast('åˆ é™¤å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•æ‰“å°æœº
        async function testPrinter(evt, shopId, ip, port) {
            const btn = evt?.target;
            if (!btn) {
                return;
            }

            const originalText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> æµ‹è¯•ä¸­...';

            try {
                const response = await fetch(`/api/shops/${shopId}/printers/${ip}/test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ port })
                });

                const data = await response.json();
                if (data.success) {
                    showToast('æµ‹è¯•æ‰“å°å·²å‘é€ï¼Œè¯·æ£€æŸ¥æ‰“å°æœº');
                } else {
                    showToast('æµ‹è¯•å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // æ˜¾ç¤ºéƒ¨ç½²è„šæœ¬
        async function showDeployModal(shopId) {
            document.getElementById('deployModal').classList.add('active');
            const wslEl = document.getElementById('deployCommandWsl');
            const macEl = document.getElementById('deployCommandMac');
            wslEl.textContent = 'åŠ è½½ä¸­...';
            macEl.textContent = 'åŠ è½½ä¸­...';
            delete wslEl.dataset.command;
            delete macEl.dataset.command;

            try {
                const response = await fetch(`/api/shops/${shopId}/deploy`);
                const data = await response.json();
                if (data.success) {
                    const wslCommand = data.linuxCommand || data.curlCommand || data.commands?.default;
                    const macCommand = data.macCommand || data.commands?.mac;

                    if (wslCommand) {
                        wslEl.textContent = wslCommand;
                        wslEl.dataset.command = wslCommand;
                    } else {
                        wslEl.textContent = 'æœªæä¾›éƒ¨ç½²å‘½ä»¤';
                    }

                    if (macCommand) {
                        macEl.textContent = macCommand;
                        macEl.dataset.command = macCommand;
                    } else {
                        macEl.textContent = 'æš‚æœªæä¾› macOS éƒ¨ç½²å‘½ä»¤';
                    }
                } else {
                    const msg = 'åŠ è½½å¤±è´¥: ' + data.error;
                    wslEl.textContent = msg;
                    macEl.textContent = msg;
                }
            } catch (error) {
                const msg = 'åŠ è½½å¤±è´¥: ' + error.message;
                wslEl.textContent = msg;
                macEl.textContent = msg;
            }
        }

        function copyDeployCommand(event, variant = 'wsl') {
            const targetId = variant === 'mac' ? 'deployCommandMac' : 'deployCommandWsl';
            const commandEl = document.getElementById(targetId);
            if (!commandEl) {
                showToast('å¤åˆ¶å¤±è´¥ï¼Œæœªæ‰¾åˆ°å‘½ä»¤åŒºåŸŸ', 'error');
                return;
            }

            const command = commandEl.dataset.command || commandEl.textContent.trim();
            if (command === 'åŠ è½½ä¸­...' || !command || command.startsWith('åŠ è½½å¤±è´¥')) {
                showToast('å‘½ä»¤å°šæœªåŠ è½½å®Œæˆ', 'error');
                return;
            }

            const btn = event ? event.target : document.querySelector('#deployModal .copy-btn');

            const handleSuccess = () => {
                if (btn) {
                    const originalText = btn.textContent;
                    btn.textContent = 'å·²å¤åˆ¶!';
                    btn.classList.add('copied');
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.classList.remove('copied');
                    }, 2000);
                }
                showToast('å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            };

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(command).then(handleSuccess).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopy(command, btn);
                });
            } else {
                fallbackCopy(command, btn);
            }
        }
        
        // Fallback å¤åˆ¶æ–¹æ³•
        function fallbackCopy(text, context) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (!successful) {
                    showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶', 'error');
                    return;
                }
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶', 'error');
                return;
            } finally {
                document.body.removeChild(textArea);
            }

            if (typeof context === 'function') {
                context();
                return;
            }

            if (context) {
                const originalText = context.textContent;
                context.textContent = 'å·²å¤åˆ¶!';
                context.classList.add('copied');
                setTimeout(() => {
                    context.textContent = originalText;
                    context.classList.remove('copied');
                }, 2000);
            }
            showToast('å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }

        function closeModal() {
            document.getElementById('shopModal').classList.remove('active');
            document.getElementById('shopForm').reset();
            const idInput = document.getElementById('shopId');
            idInput.disabled = false;
            document.getElementById('modalTitle').textContent = 'æ·»åŠ åˆ†åº—';
            currentShopId = null;
            isEditingShop = false;
        }

        function closePrinterModal() {
            document.getElementById('printerModal').classList.remove('active');
            document.getElementById('printerForm').reset();
            document.getElementById('printerPort').value = '9100';
            currentShopId = null;
            isEditingPrinter = false;
            editingPrinterOriginalIp = null;
            document.getElementById('printerModalTitle').textContent = 'æ·»åŠ æ‰“å°æœº';
            document.getElementById('printerSubmitBtn').textContent = 'æ·»åŠ ';
        }

        function closeDeployModal() {
            document.getElementById('deployModal').classList.remove('active');
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = type === 'error' ? '#ef4444' : '#10b981';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function copyTextToClipboard({ event, text, onSuccess }) {
            const doCopy = (content) => {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(content).then(onSuccess).catch(() => fallbackCopy(content, onSuccess))
                } else {
                    fallbackCopy(content, onSuccess)
                }
            }

            doCopy(text)

            if (event) {
                event.preventDefault()
            }
        }

        function copyWSLFixCommand(event) {
            const commandEl = document.getElementById('wslFixCommand');
            const command = commandEl ? commandEl.textContent.trim() : 'curl -s https://pa.easyify.uk/fix-wsl-network.sh | bash';
            const onSuccess = () => {
                const btn = event ? event.target : document.querySelector('#wslFixCommand').parentElement.querySelector('.copy-btn');
                if (btn) {
                    const originalText = btn.textContent;
                    btn.textContent = 'å·²å¤åˆ¶!';
                    btn.style.background = '#10b981';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#374151';
                    }, 2000);
                }
                showToast('å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }

            copyTextToClipboard({ event, text: command, onSuccess })
        }

        function copyRestDeskInfo(event) {
            const info = document.getElementById('restDeskInfo');
            const text = info ? info.textContent.trim() : '';
            const onSuccess = () => {
                const btn = event ? event.target : document.querySelector('#restDeskInfo').parentElement.querySelector('.copy-btn');
                if (btn) {
                    const originalText = btn.textContent;
                    btn.textContent = 'å·²å¤åˆ¶!';
                    btn.style.background = '#4c1d95';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#4c1d95';
                    }, 2000);
                }
                showToast('RestDesk ä¿¡æ¯å·²å¤åˆ¶');
            }

            copyTextToClipboard({ event, text, onSuccess })
        }

        // å®šæœŸåˆ·æ–°æ•°æ®
        loadData();
        setInterval(loadData, 5000);
    </script>
</body>
</html>


