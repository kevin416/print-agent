# 🏗️ 架构详解

## 设计理念

Print Agent 采用**本地代理模式**，将网络访问的责任从服务器转移到本地代理，大大简化了配置和部署。

## 核心组件

### 1. 服务器端（print-agent-server）

**职责：**
- 接收来自浏览器的 HTTP 打印请求
- 管理本地代理的 WebSocket 连接
- 路由打印任务到正确的本地代理
- 提供健康检查和状态查询接口

**特点：**
- 无需 VPN 配置
- 无需访问分店网络
- 只做消息中转，不直接连接打印机

### 2. 本地代理端（local-print-agent）

**职责：**
- 通过 WebSocket 连接到服务器
- 接收打印任务
- 将打印数据转发到本地打印机
- 处理编码转换（UTF-8 → GBK）

**特点：**
- 运行在分店电脑上
- 可以直接访问本地打印机
- 自动重连机制
- 心跳保活

## 数据流

### 打印请求流程

\`\`\`
1. 浏览器（FastPrintLib）
   ↓ HTTP POST
   /api/print?host=192.168.0.172&port=9100
   Headers: X-Shop-Name: shop1
   Body: UTF-8 编码的打印数据
   
2. 服务器（print-agent-server）
   ↓ 验证请求
   - 检查 X-Shop-Name 头
   - 检查本地代理是否已连接
   ↓ WebSocket 消息
   {
     type: 'print',
     taskId: 'xxx',
     printerIP: '192.168.0.172',
     port: 9100,
     data: 'base64编码的数据',
     encoding: 'base64'
   }
   
3. 本地代理（local-print-agent）
   ↓ 解码数据
   - base64 → UTF-8 Buffer
   - UTF-8 → GBK（使用 iconv-lite）
   ↓ TCP Socket
   连接到 192.168.0.172:9100
   发送 GBK 编码的数据
   
4. 打印机
   ↓ 接收数据并打印
   
5. 响应返回
   本地代理 → 服务器（WebSocket）
   服务器 → 浏览器（HTTP）
\`\`\`

## 为什么不需要 VPN？

### 旧方案（VPN）的问题

\`\`\`
浏览器 → 服务器 → VPN 隧道 → 分店网络 → 打印机
         ↑
    需要：
    - VPN 服务器配置
    - VPN 客户端配置
    - 路由配置
    - 防火墙规则
    - 网络转发配置
\`\`\`

**问题：**
- ❌ 配置复杂
- ❌ 需要 VPN 客户端
- ❌ 需要网络转发
- ❌ 跨城市部署困难
- ❌ 服务器需要访问分店网络

### 新方案（本地代理）的优势

\`\`\`
浏览器 → 服务器 → WebSocket → 本地代理 → 打印机
         ↑                    ↑
    需要：                需要：
    - HTTP 服务          - 运行本地代理
    - WebSocket 服务     - 配置 shopId
    - 无需 VPN！         - 无需网络配置！
\`\`\`

**优势：**
- ✅ 配置简单
- ✅ 无需 VPN
- ✅ 无需网络转发
- ✅ 跨城市部署容易
- ✅ 服务器不需要访问分店网络

## 关键技术点

### 1. WebSocket 双向通信

- 服务器和本地代理通过 WebSocket 保持长连接
- 支持心跳保活（ping/pong）
- 自动重连机制

### 2. 编码转换

- 浏览器发送 UTF-8 编码的数据
- 本地代理转换为 GBK 编码（中文打印机常用）
- 使用 \`iconv-lite\` 库进行转换

### 3. 分店识别

- 通过 \`X-Shop-Name\` HTTP 头识别分店
- 通过 \`X-Shop-Id\` WebSocket 头识别本地代理
- 服务器维护 \`shopId → WebSocket\` 的映射

### 4. 错误处理

- 连接超时处理
- 打印机连接失败处理
- 自动重试机制
- 详细的错误日志

## 扩展性

### 多分店支持

- 每个分店运行一个本地代理
- 使用不同的 \`shopId\` 区分
- 服务器可以同时管理多个连接

### 负载均衡

- 可以部署多个服务器实例
- 使用 Nginx 进行负载均衡
- 每个实例独立管理本地代理连接

### 监控和日志

- 服务器提供健康检查接口
- 本地代理提供状态接口
- 详细的日志记录

## 安全性

### 当前实现

- 通过 \`X-Shop-Name\` 头验证分店
- WebSocket 连接需要 \`X-Shop-Id\` 头

### 建议增强

1. **shopId 白名单**：服务器维护允许的 shopId 列表
2. **打印机 IP 白名单**：每个分店只能访问指定的打印机
3. **SSL/TLS**：使用 WSS 和 HTTPS
4. **认证令牌**：添加 JWT 或其他认证机制

## 性能优化

### 连接池

- 服务器维护 WebSocket 连接池
- 避免频繁建立和断开连接

### 数据压缩

- 可以考虑对打印数据进行压缩（gzip）
- 减少网络传输量

### 批量打印

- 支持批量打印任务
- 减少网络往返次数

## 故障恢复

### 本地代理断开

- 自动重连机制
- 服务器检测连接状态
- 打印请求失败时返回明确错误

### 服务器重启

- 本地代理自动重连
- 保持连接状态

### 网络中断

- 心跳检测网络状态
- 自动重连
- 任务队列（可选）
