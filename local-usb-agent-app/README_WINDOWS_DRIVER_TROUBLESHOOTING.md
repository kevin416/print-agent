# Windows USB 驱动问题排查指南

## 问题：已安装 WinUSB 驱动但仍出现 LIBUSB_ERROR_NOT_SUPPORTED

如果你的设备管理器中显示 WinUSB 驱动已安装（显示为 `libwdi` 提供商），但 Agent 仍然报告 `LIBUSB_ERROR_NOT_SUPPORTED` 错误，请按照以下步骤排查：

### 步骤 1：检查设备管理器中的设备实例

1. **打开设备管理器**
   - 按 `Win + X`，选择"设备管理器"
   - 或运行 `devmgmt.msc`

2. **查找重复的设备条目**
   - 展开"通用串行总线控制器"
   - 展开"通用串行总线设备"
   - 查找你的设备（VID: 0xfe6, PID: 0x811e）

3. **检查每个设备实例的驱动**
   - 右键点击设备 → 属性 → 驱动程序
   - 查看"驱动程序提供商"
   - 如果看到：
     - `libwdi` - 这是 WinUSB 驱动（正确）
     - `Microsoft` - 这可能是 usbprint 驱动（需要卸载）
     - 原厂驱动名称 - 这是原厂驱动（需要卸载）

### 步骤 2：卸载冲突的设备实例

**重要**：如果设备同时出现在两个位置，需要卸载非 WinUSB 驱动的实例。

1. **找到 usbprint 驱动的设备实例**
   - 在设备管理器中，找到显示为"USB 打印支持"或原厂驱动名称的设备
   - 通常在"通用串行总线设备"或"打印机"分类下

2. **卸载设备**
   - 右键点击设备 → 卸载设备
   - **重要**：勾选"删除此设备的驱动程序软件"
   - 点击"卸载"

3. **重新插拔设备**
   - 拔掉 USB 打印机
   - 等待 5-10 秒
   - 重新插入 USB 打印机
   - 等待 Windows 识别设备

4. **验证设备实例**
   - 在设备管理器中，确认设备只出现在一个位置
   - 确认设备显示为"WinUSB Device"或使用 `libwdi` 驱动
   - 如果设备仍然出现在两个位置，重复步骤 2

### 步骤 3：尝试不同的驱动

如果使用 libwdi 驱动仍然有问题，尝试切换到 Microsoft 官方的 WinUSB 驱动：

1. **重新打开 Zadig**
   - 以管理员身份运行 Zadig
   - 菜单 `Options` → 勾选 `List All Devices`

2. **选择设备**
   - 在下拉列表中找到你的设备（VID: 0xfe6, PID: 0x811e）
   - 确保选择的是正确的接口（Interface）

3. **切换驱动**
   - 如果当前是 `libusbK`，尝试切换到 `WinUSB (v6.x)`
   - 如果当前是 `WinUSB (v6.x)`，尝试切换到 `libusbK`
   - 点击 `Replace Driver`

4. **重新插拔设备并测试**
   - 拔掉 USB 打印机
   - 等待 5-10 秒
   - 重新插入 USB 打印机
   - 重新启动 Agent 应用程序
   - 测试打印

### 步骤 4：检查设备是否被其他程序占用

1. **关闭所有可能使用打印机的程序**
   - 关闭所有浏览器标签页（如果使用 Web 打印）
   - 关闭所有可能访问打印机的应用程序

2. **检查 Windows 打印队列**
   - 打开"设置" → "设备" → "打印机和扫描仪"
   - 找到你的打印机
   - 点击"打开队列"
   - 如果有挂起的任务，取消所有任务

3. **检查任务管理器**
   - 按 `Ctrl + Shift + Esc` 打开任务管理器
   - 查找可能占用打印机的进程
   - 如果有可疑进程，结束进程

### 步骤 5：查看详细日志

1. **打开 Agent 控制面板**
   - 点击托盘图标 → 打开控制面板

2. **查看日志**
   - 点击"日志"标签
   - 查看最近的错误日志
   - 日志会显示详细的错误信息，包括：
      - 设备打开失败的具体原因
      - 接口声明失败的具体原因
      - 端点查找失败的具体原因

3. **分析日志信息**
   - 查找 `LIBUSB_ERROR_NOT_SUPPORTED` 错误
   - 查看错误发生的具体步骤（设备打开、接口声明、端点查找）
   - 根据错误信息进一步排查问题

### 步骤 6：完全重新安装驱动

如果以上步骤都没有解决问题，尝试完全重新安装驱动：

1. **卸载所有设备实例**
   - 在设备管理器中，找到所有相关的设备实例
   - 右键点击 → 卸载设备
   - **重要**：勾选"删除此设备的驱动程序软件"
   - 对所有实例重复此操作

2. **清理驱动缓存**
   - 打开"设置" → "系统" → "存储"
   - 点击"临时文件"
   - 勾选"设备驱动程序包"
   - 点击"删除文件"

3. **重新安装驱动**
   - 拔掉 USB 打印机
   - 等待 10 秒
   - 重新插入 USB 打印机
   - 在 Zadig 中重新安装 WinUSB 驱动

4. **测试打印**
   - 重新启动 Agent 应用程序
   - 测试打印

## 常见问题

### Q: 为什么设备会出现在两个位置？

A: 这是因为 Windows 可能同时识别了原驱动（usbprint）和 WinUSB 驱动。需要卸载原驱动的设备实例。

### Q: 卸载设备后，设备消失了怎么办？

A: 重新插拔设备，Windows 应该会重新识别设备。如果设备没有重新出现，检查 USB 连接或尝试不同的 USB 端口。

### Q: 如何确认驱动切换成功？

A: 在设备管理器中，查看设备属性 → 驱动程序。如果显示：
- 驱动程序提供商：`libwdi` 或 `Microsoft`
- 驱动程序文件：`winusb.sys`
说明驱动切换成功。

### Q: libwdi 和 Microsoft WinUSB 有什么区别？

A: 
- `libwdi`：Zadig 使用的驱动安装工具，会自动生成驱动安装包
- `Microsoft WinUSB`：Microsoft 官方的 WinUSB 驱动
- 两者功能相同，但某些设备可能对特定驱动更兼容

### Q: 如何查看详细的错误信息？

A: 在 Agent 控制面板中，点击"日志"标签，查看最近的错误日志。日志会显示详细的错误信息，包括错误代码、错误消息和堆栈跟踪。

## 技术支持

如果以上步骤都没有解决问题，请提供以下信息：

1. 设备管理器截图（显示设备位置和驱动信息）
2. Agent 日志文件（`%APPDATA%\YeposAgent\Logs\agent.log`）
3. 错误发生的具体步骤（设备打开、接口声明、端点查找）
4. Windows 版本和系统信息

## 相关链接

- [Zadig 官网](https://zadig.akeo.ie/)
- [WinUSB 驱动文档](https://docs.microsoft.com/en-us/windows-hardware/drivers/usbcon/winusb-installation)
- [libusb 文档](https://libusb.info/)

